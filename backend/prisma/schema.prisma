// Prisma Schema cho Hệ Thống Tính Lương
// Tất cả tên bảng và trường đều sử dụng tiếng Việt (không dấu)

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// BẢNG PHÒNG BAN (HỖ TRỢ CÂY PHÂN CẤP)
// ============================================
model PhongBan {
  id          Int     @id @default(autoincrement())
  maPhongBan  String  @unique @map("ma_phong_ban")
  tenPhongBan String  @map("ten_phong_ban")
  moTa        String? @map("mo_ta")
  trangThai   String  @default("HOAT_DONG") @map("trang_thai") // HOAT_DONG | NGUNG_HOAT_DONG

  // === CÂY PHÒNG BAN (MỚI) ===
  phongBanChaId Int?    @map("phong_ban_cha_id") // Self reference - parent department
  capDo         Int     @default(1) @map("cap_do") // Level depth: 1=công ty, 2=khối, 3=phòng, 4=tổ
  loaiPhongBan  String? @map("loai_phong_ban") // VAN_HANH | KINH_DOANH | VAN_PHONG | SAN_XUAT
  nguoiQuanLyId Int?    @map("nguoi_quan_ly_id") // ID nhân viên quản lý phòng ban

  // Cấu hình giờ làm việc riêng theo phòng ban
  gioVaoChuan    String @default("08:00") @map("gio_vao_chuan") // Format: HH:mm
  gioRaChuan     String @default("17:00") @map("gio_ra_chuan") // Format: HH:mm
  phutChoPhepTre Int    @default(5) @map("phut_cho_phep_tre") // Số phút được phép đi muộn
  // Cấu hình quy tắc ngày công theo phòng ban
  quyTacNgayCong String? @default("SAT_HALF_SUN_OFF") @map("quy_tac_ngay_cong") // FULL | SAT_HALF_SUN_OFF
  // Cấu hình số ngày công cố định theo tháng (ưu tiên hơn quy tắc nếu có)
  soNgayCongThang Int?   @map("so_ngay_cong_thang")

  // Audit fields
  taoBoi      Int?     @map("tao_boi")
  capNhatBoi  Int?     @map("cap_nhat_boi")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ cây phòng ban
  phongBanCha  PhongBan?  @relation("CayPhongBan", fields: [phongBanChaId], references: [id])
  phongBanCons PhongBan[] @relation("CayPhongBan")

  // Quan hệ khác
  nhanViens           NhanVien[]
  coCauLuongs         CoCauLuong[]
  bangLuongs          BangLuong[]
  quyChe              QuyChe[]
  nhanVienTrachNhiems NhanVienTrachNhiem[]
  suKienThuongPhats   SuKienThuongPhat[]
  aiRuleAudits        AiRuleAudit[]
  cauHinhDonGias      CauHinhDonGia[]
  donViCons           DonViCon[]
  lichSuNhanViens     NhanVienPhongBan[]
  phanQuyens          PhanQuyenPhongBan[]
  cauHinhImports      CauHinhImportPhongBan[]
  // Module nghỉ phép
  donNghiPheps        DonNghiPhep[]
  // Module yêu cầu (Sprint 4)
  donYeuCaus          DonYeuCau[]

  @@index([phongBanChaId, capDo])
  @@map("phong_ban")
}

// ============================================
// ĐƠN VỊ CON (TỔ/NHÓM/CA)
// Đơn vị nhỏ hơn phòng ban (tổ sản xuất, ca làm việc...)
// ============================================
model DonViCon {
  id         Int    @id @default(autoincrement())
  phongBanId Int    @map("phong_ban_id")
  maDonVi    String @map("ma_don_vi")
  tenDonVi   String @map("ten_don_vi")
  loaiDonVi  String @map("loai_don_vi") // TO | NHOM | CA
  trangThai  String @default("HOAT_DONG") @map("trang_thai") // HOAT_DONG | NGUNG_HOAT_DONG

  taoBoi  Int?     @map("tao_boi")
  ngayTao DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  phongBan        PhongBan           @relation(fields: [phongBanId], references: [id])
  lichSuNhanViens NhanVienPhongBan[]

  @@unique([phongBanId, maDonVi])
  @@map("don_vi_con")
}

// ============================================
// LỊCH SỬ NHÂN VIÊN THUỘC PHÒNG BAN/TỔ/CA
// Theo dõi nhân viên chuyển phòng ban theo thời gian
// ============================================
model NhanVienPhongBan {
  id         Int       @id @default(autoincrement())
  nhanVienId Int       @map("nhan_vien_id")
  phongBanId Int       @map("phong_ban_id")
  donViConId Int?      @map("don_vi_con_id") // Tổ/Ca nếu có
  tuNgay     DateTime  @map("tu_ngay") @db.Date
  denNgay    DateTime? @map("den_ngay") @db.Date // null = còn hiệu lực
  ghiChu     String?   @map("ghi_chu")

  taoBoi  Int?     @map("tao_boi")
  ngayTao DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  nhanVien NhanVien  @relation(fields: [nhanVienId], references: [id])
  phongBan PhongBan  @relation(fields: [phongBanId], references: [id])
  donViCon DonViCon? @relation(fields: [donViConId], references: [id])

  @@index([nhanVienId, tuNgay, denNgay])
  @@index([phongBanId, donViConId])
  @@map("nhan_vien_phong_ban")
}

// ============================================
// PHÂN QUYỀN THEO PHÒNG BAN (RBAC THEO PHẠM VI)
// Cho phép user có quyền riêng theo từng phòng ban
// ============================================
model PhanQuyenPhongBan {
  id          Int    @id @default(autoincrement())
  nguoiDungId Int    @map("nguoi_dung_id") // ID từ bảng User
  phongBanId  Int    @map("phong_ban_id")
  quyen       String @map("quyen") // IMPORT | XEM | PAYROLL | QUAN_TRI

  taoBoi  Int?     @map("tao_boi")
  ngayTao DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  phongBan PhongBan @relation(fields: [phongBanId], references: [id])

  @@unique([nguoiDungId, phongBanId, quyen])
  @@map("phan_quyen_phong_ban")
}

// ============================================
// CẤU HÌNH IMPORT THEO PHÒNG BAN
// Cấu hình riêng cho từng loại import của phòng ban
// ============================================
model CauHinhImportPhongBan {
  id              Int     @id @default(autoincrement())
  phongBanId      Int     @map("phong_ban_id")
  loaiImport      String  @map("loai_import") // CHIA_HANG | GIAO_HANG
  batBuocDonViCon Boolean @default(false) @map("bat_buoc_don_vi_con")
  gioiHanSoDong   Int     @default(5000) @map("gioi_han_so_dong")
  trangThai       String  @default("HOAT_DONG") @map("trang_thai")

  ngayTao DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  phongBan PhongBan @relation(fields: [phongBanId], references: [id])

  @@unique([phongBanId, loaiImport])
  @@map("cau_hinh_import_phong_ban")
}

// ============================================
// BẢNG NHÂN VIÊN
// ============================================
model NhanVien {
  id           Int               @id @default(autoincrement())
  maNhanVien   String            @unique @map("ma_nhan_vien")
  hoTen        String            @map("ho_ten")
  email        String?           @unique
  soDienThoai  String?           @map("so_dien_thoai")
  phongBanId   Int               @map("phong_ban_id")
  chucVu       String?           @map("chuc_vu")
  // Loại nhân viên: THU_VIEC, CHINH_THUC, HOC_VIEC, THUC_TAP, CONG_TAC_VIEN
  loaiNhanVien LoaiNhanVien      @default(CHINH_THUC) @map("loai_nhan_vien")
  // Có đóng BHXH hay không - ảnh hưởng đến khấu trừ bảng lương
  dongBHXH     Boolean           @default(true) @map("dong_bhxh")
  // Deprecated: luongCoBan sẽ được lấy từ HopDong, giữ lại để migration
  luongCoBan   Decimal           @default(0) @map("luong_co_ban") @db.Decimal(15, 0)
  ngayVaoLam   DateTime          @default(now()) @map("ngay_vao_lam")
  ngayNghiViec DateTime?         @map("ngay_nghi_viec")
  gioiTinh     GioiTinh?         @map("gioi_tinh")
  ngaySinh     DateTime?         @map("ngay_sinh") @db.Date
  diaChi       String?           @map("dia_chi")
  // CCCD/CMND
  soCCCD       String?           @map("so_cccd")
  hinhCCCDTruoc String?          @map("hinh_cccd_truoc") // URL hình CCCD mặt trước
  hinhCCCDSau   String?          @map("hinh_cccd_sau")   // URL hình CCCD mặt sau
  // Liên hệ khẩn cấp
  soDienThoaiKhanCap  String?    @map("so_dien_thoai_khan_cap")
  nguoiLienHeKhanCap  String?    @map("nguoi_lien_he_khan_cap") // Tên người thân
  quanHeKhanCap       String?    @map("quan_he_khan_cap")       // Quan hệ (cha, mẹ, vợ, chồng...)
  trangThai    TrangThaiNhanVien @default(DANG_LAM) @map("trang_thai")
  taoBoi       Int?              @map("tao_boi")
  capNhatBoi   Int?              @map("cap_nhat_boi")
  ngayTao      DateTime          @default(now()) @map("ngay_tao")
  ngayCapNhat  DateTime          @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  phongBan            PhongBan              @relation(fields: [phongBanId], references: [id])
  chiTietBangLuongs   ChiTietBangLuong[]
  lichSuChinhSuas     LichSuChinhSua[]
  phuCaps             PhuCapNhanVien[]
  nguoiPhuThuocs      NguoiPhuThuoc[]
  phieuDieuChinhs     PhieuDieuChinh[]
  chamCongs           ChamCong[]
  ngayCongBangLuongs  NgayCongBangLuong[]
  nhanVienTrachNhiems NhanVienTrachNhiem[]
  suKienThuongPhats   SuKienThuongPhat[]
  ruleTraces          RuleTrace[]
  // Quan hệ mới - Module nâng cấp
  hopDongs            NhanVienHopDong[]
  nganHangs           NhanVienNganHang[]
  thueBaoHiem         NhanVienThueBH?
  thuocNhoms          NhanVienThuocNhom[]
  lichSuPhongBans     NhanVienPhongBan[] // Lịch sử thuộc phòng ban theo thời gian
  // Module nghỉ phép
  donNghiPheps        DonNghiPhep[]
  chiTietNghiPheps    ChiTietNghiPhepNgay[]
  // Module yêu cầu (Sprint 4)
  donYeuCaus          DonYeuCau[]
  // Module sản lượng
  sanLuongChiaHangs   SanLuongChiaHang[]
  giaoHangs           GiaoHang[]

  @@map("nhan_vien")
}

enum LoaiNhanVien {
  THU_VIEC       // Thử việc
  CHINH_THUC     // Chính thức
  HOC_VIEC       // Học việc
  THUC_TAP       // Thực tập
  CONG_TAC_VIEN  // Cộng tác viên
  THOI_VU        // Thời vụ

  @@map("loai_nhan_vien")
}

enum GioiTinh {
  NAM
  NU
  KHAC

  @@map("gioi_tinh")
}

enum TrangThaiNhanVien {
  DANG_LAM
  NGHI_VIEC
  TAM_NGHI

  @@map("trang_thai_nhan_vien")
}

// ============================================
// DANH MỤC KHOẢN LƯƠNG (CỰC KỲ QUAN TRỌNG)
// Thay thế toàn bộ các cột trong Excel
// ============================================
model KhoanLuong {
  id           Int            @id @default(autoincrement())
  maKhoan      String         @unique @map("ma_khoan")
  tenKhoan     String         @map("ten_khoan")
  loai         LoaiKhoanLuong @default(THU_NHAP)
  cachTinh     CachTinhLuong  @default(LUONG_THANG_CO_DINH) @map("cach_tinh")
  chiuThue     Boolean        @default(false) @map("chiu_thue")
  phamViApDung String?        @map("pham_vi_ap_dung") // null = toàn công ty
  moTa         String?        @map("mo_ta")
  thuTu        Int            @default(0) @map("thu_tu") // Thứ tự hiển thị
  trangThai    Boolean        @default(true) @map("trang_thai")
  ngayTao      DateTime       @default(now()) @map("ngay_tao")
  ngayCapNhat  DateTime       @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  coCauLuongChiTiets CoCauLuongChiTiet[]
  chiTietBangLuongs  ChiTietBangLuong[]
  lichSuChinhSuas    LichSuChinhSua[]
  phuCapNhanViens    PhuCapNhanVien[]
  chiTietPhieuDCs    ChiTietPhieuDieuChinh[]
  quyCheRules        QuyCheRule[]
  ruleTraces         RuleTrace[]

  @@map("khoan_luong")
}

enum LoaiKhoanLuong {
  THU_NHAP // Các khoản cộng vào lương
  KHAU_TRU // Các khoản trừ đi (BHXH, thuế...)

  @@map("loai_khoan_luong")
}

// Cách tính lương cho từng khoản
enum CachTinhLuong {
  LUONG_THANG_CO_DINH // Lương cố định tháng, không chia theo ngày
  THEO_NGAY_CONG // Phụ cấp theo ngày = giá trị × (ngày thực tế / ngày lý thuyết)
  CHUYEN_CAN_DIEU_KIEN // Full nếu nghỉ không phép <= 2 ngày, 0 nếu > 2 ngày

  @@map("cach_tinh_luong")
}

// ============================================
// CƠ CẤU LƯƠNG THEO PHÒNG BAN
// Mỗi phòng ban có cơ cấu lương riêng
// ============================================
model CoCauLuong {
  id          Int      @id @default(autoincrement())
  phongBanId  Int      @map("phong_ban_id")
  tenCoCau    String   @map("ten_co_cau")
  moTa        String?  @map("mo_ta")
  trangThai   Boolean  @default(true) @map("trang_thai")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  phongBan PhongBan            @relation(fields: [phongBanId], references: [id])
  chiTiets CoCauLuongChiTiet[]

  @@map("co_cau_luong")
}

// ============================================
// CHI TIẾT CƠ CẤU LƯƠNG
// Định nghĩa các khoản lương trong cơ cấu
// ============================================
model CoCauLuongChiTiet {
  id            Int      @id @default(autoincrement())
  coCauLuongId  Int      @map("co_cau_luong_id")
  khoanLuongId  Int      @map("khoan_luong_id")
  batBuoc       Boolean  @default(false) @map("bat_buoc")
  giaTriMacDinh Decimal  @default(0) @map("gia_tri_mac_dinh") @db.Decimal(15, 0)
  ngayTao       DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat   DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  coCauLuong CoCauLuong @relation(fields: [coCauLuongId], references: [id], onDelete: Cascade)
  khoanLuong KhoanLuong @relation(fields: [khoanLuongId], references: [id])

  @@unique([coCauLuongId, khoanLuongId])
  @@map("co_cau_luong_chi_tiet")
}

// ============================================
// BẢNG LƯƠNG THÁNG
// Quản lý bảng lương theo tháng/phòng ban
// ============================================
model BangLuong {
  id           Int                @id @default(autoincrement())
  thang        Int // 1-12
  nam          Int // 2024, 2025...
  phongBanId   Int                @map("phong_ban_id")
  tenBangLuong String?            @map("ten_bang_luong")
  trangThai    TrangThaiBangLuong @default(NHAP) @map("trang_thai")
  ngayChot     DateTime?          @map("ngay_chot")
  nguoiChot    String?            @map("nguoi_chot")
  ghiChu       String?            @map("ghi_chu")
  ngayTao      DateTime           @default(now()) @map("ngay_tao")
  ngayCapNhat  DateTime           @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  phongBan          PhongBan                   @relation(fields: [phongBanId], references: [id])
  chiTiets          ChiTietBangLuong[]
  ngayCong          NgayCongBangLuong[]
  quyChe            BangLuongQuyChe[]
  ruleTraces        RuleTrace[]
  snapshotChiaHangs SnapshotSanLuongChiaHang[]
  snapshotGiaoHangs SnapshotGiaoHang[]

  @@unique([thang, nam, phongBanId])
  @@index([thang, nam])
  @@index([phongBanId])
  @@index([trangThai])
  @@map("bang_luong")
}

// ============================================
// NGÀY CÔNG BẢNG LƯƠNG
// Lưu ngày công đã điều chỉnh thủ công cho từng nhân viên trong bảng lương
// ============================================
model NgayCongBangLuong {
  id                   Int      @id @default(autoincrement())
  bangLuongId          Int      @map("bang_luong_id")
  nhanVienId           Int      @map("nhan_vien_id")
  ngayCongLyThuyet     Decimal  @map("ngay_cong_ly_thuyet") @db.Decimal(5, 2) // VD: 22.00
  soCongThucTe         Decimal  @map("so_cong_thuc_te") @db.Decimal(5, 2) // Số công đi làm thực tế
  soNgayNghiPhep       Decimal  @default(0) @map("so_ngay_nghi_phep") @db.Decimal(5, 2) // Nghỉ có phép (vẫn tính lương) - backward compat
  soNgayNghiKhongPhep  Decimal  @default(0) @map("so_ngay_nghi_khong_phep") @db.Decimal(5, 2) // Nghỉ không phép - backward compat
  // Fields mới cho module nghỉ phép
  soNgayNghiCoPhep     Decimal  @default(0) @map("so_ngay_nghi_co_phep") @db.Decimal(5, 2) // Nghỉ có phép (từ module nghỉ phép)
  soNgayNghiCoLuong    Decimal  @default(0) @map("so_ngay_nghi_co_luong") @db.Decimal(5, 2) // Nghỉ có tính lương
  soNgayNghiKhongLuong Decimal  @default(0) @map("so_ngay_nghi_khong_luong") @db.Decimal(5, 2) // Nghỉ không lương
  ngayCongDieuChinh    Decimal? @map("ngay_cong_dieu_chinh") @db.Decimal(5, 2) // Ngày công sau khi điều chỉnh thủ công
  ghiChu               String?  @map("ghi_chu")
  ngayTao              DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat          DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  bangLuong BangLuong @relation(fields: [bangLuongId], references: [id], onDelete: Cascade)
  nhanVien  NhanVien  @relation(fields: [nhanVienId], references: [id])

  @@unique([bangLuongId, nhanVienId])
  @@index([bangLuongId])
  @@index([nhanVienId])
  @@map("ngay_cong_bang_luong")
}

enum TrangThaiBangLuong {
  NHAP // Đang nhập liệu
  DA_CHOT // Đã chốt, không sửa được
  KHOA // Đã khoá hoàn toàn

  @@map("trang_thai_bang_luong")
}

// ============================================
// CHI TIẾT BẢNG LƯƠNG (LINH HỒN HỆ THỐNG)
// Mỗi ô trong Excel = 1 dòng ở bảng này
// ============================================
model ChiTietBangLuong {
  id           Int          @id @default(autoincrement())
  bangLuongId  Int          @map("bang_luong_id")
  nhanVienId   Int          @map("nhan_vien_id")
  khoanLuongId Int          @map("khoan_luong_id")
  soTien       Decimal      @default(0) @map("so_tien") @db.Decimal(15, 0)
  nguon        NguonChiTiet @default(NHAP_TAY) @map("nguon") // CO_DINH = từ phụ cấp, NHAP_TAY = nhập thủ công
  ghiChu       String?      @map("ghi_chu")
  ngayTao      DateTime     @default(now()) @map("ngay_tao")
  ngayCapNhat  DateTime     @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  bangLuong  BangLuong  @relation(fields: [bangLuongId], references: [id], onDelete: Cascade)
  nhanVien   NhanVien   @relation(fields: [nhanVienId], references: [id])
  khoanLuong KhoanLuong @relation(fields: [khoanLuongId], references: [id])

  @@unique([bangLuongId, nhanVienId, khoanLuongId])
  @@index([bangLuongId])
  @@index([nhanVienId])
  @@index([khoanLuongId])
  @@map("chi_tiet_bang_luong")
}

// Nguồn dữ liệu chi tiết bảng lương
enum NguonChiTiet {
  CO_DINH // Từ phụ cấp cố định nhân viên (không cho sửa trong bảng lương)
  NHAP_TAY // Nhập thủ công trong bảng lương
  CHAM_CONG // Từ tính toán chấm công (phạt đi muộn, về sớm, nghỉ không phép)
  RULE // Từ Rule Engine tính tự động
  PHAT_SINH // Phát sinh trong kỳ (thưởng/phạt)
  DIEU_CHINH // Từ phiếu điều chỉnh
  UNG_LUONG // Từ bảng ứng lương đã chốt

  @@map("nguon_chi_tiet")
}

// ============================================
// LỊCH SỬ CHỈNH SỬA (AUDIT LOG)
// Lưu lại mọi thay đổi trên bảng lương
// ============================================
model LichSuChinhSua {
  id           Int      @id @default(autoincrement())
  bangLuongId  Int?     @map("bang_luong_id")
  nhanVienId   Int?     @map("nhan_vien_id")
  khoanLuongId Int?     @map("khoan_luong_id")
  giaTriCu     Decimal? @map("gia_tri_cu") @db.Decimal(15, 0)
  giaTriMoi    Decimal? @map("gia_tri_moi") @db.Decimal(15, 0)
  loaiThayDoi  String   @map("loai_thay_doi") // TAO_MOI, CAP_NHAT, XOA
  nguoiThayDoi String   @map("nguoi_thay_doi")
  lyDo         String?  @map("ly_do")
  ngayThayDoi  DateTime @default(now()) @map("ngay_thay_doi")

  // Quan hệ (optional vì có thể đã xóa)
  nhanVien   NhanVien?   @relation(fields: [nhanVienId], references: [id], onDelete: SetNull)
  khoanLuong KhoanLuong? @relation(fields: [khoanLuongId], references: [id], onDelete: SetNull)

  @@map("lich_su_chinh_sua")
}

// ============================================
// MAPPING EXCEL (Lưu cấu hình mapping cột)
// ============================================
model MappingExcel {
  id            Int      @id @default(autoincrement())
  tenMapping    String   @map("ten_mapping")
  tenCotExcel   String   @map("ten_cot_excel")
  khoanLuongId  Int?     @map("khoan_luong_id")
  truongHeThong String?  @map("truong_he_thong") // ho_ten, ma_nhan_vien...
  thuTuCot      Int      @default(0) @map("thu_tu_cot")
  trangThai     Boolean  @default(true) @map("trang_thai")
  ngayTao       DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat   DateTime @updatedAt @map("ngay_cap_nhat")

  @@map("mapping_excel")
}

// ============================================
// PHỤ CẤP NHÂN VIÊN (MODULE CỐT LÕI)
// Phụ cấp cố định theo từng nhân viên
// Không lưu trong bảng lương, tự động áp dụng hàng tháng
// ============================================
model PhuCapNhanVien {
  id           Int             @id @default(autoincrement())
  nhanVienId   Int             @map("nhan_vien_id")
  khoanLuongId Int             @map("khoan_luong_id")
  soTien       Decimal         @default(0) @map("so_tien") @db.Decimal(15, 0)
  tuNgay       DateTime        @map("tu_ngay")
  denNgay      DateTime?       @map("den_ngay")
  ghiChu       String?         @map("ghi_chu")
  trangThai    TrangThaiPhuCap @default(HIEU_LUC) @map("trang_thai")
  nguoiTao     String?         @map("nguoi_tao")
  ngayTao      DateTime        @default(now()) @map("ngay_tao")
  ngayCapNhat  DateTime        @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  nhanVien   NhanVien   @relation(fields: [nhanVienId], references: [id])
  khoanLuong KhoanLuong @relation(fields: [khoanLuongId], references: [id])

  // Ràng buộc: không cho trùng khoản lương trong cùng khoảng thời gian
  // (validation sẽ thực hiện ở service layer)
  @@map("phu_cap_nhan_vien")
}

enum TrangThaiPhuCap {
  HIEU_LUC // Đang áp dụng
  TAM_DUNG // Tạm dừng
  KET_THUC // Đã kết thúc

  @@map("trang_thai_phu_cap")
}

// ============================================
// SNAPSHOT BẢNG LƯƠNG (LƯU TRỮ KHI CHỐT)
// Khi chốt lương, lưu snapshot để không bị thay đổi
// ============================================
model SnapshotBangLuong {
  id           Int            @id @default(autoincrement())
  bangLuongId  Int            @map("bang_luong_id")
  nhanVienId   Int            @map("nhan_vien_id")
  maNhanVien   String         @map("ma_nhan_vien")
  hoTen        String         @map("ho_ten")
  phongBan     String         @map("phong_ban")
  phongBanId   Int?           @map("phong_ban_id") // Snapshot phong ban ID tại thời điểm chốt
  donViConId   Int?           @map("don_vi_con_id") // Snapshot đơn vị con (Tổ/Ca) tại thời điểm chốt
  donViCon     String?        @map("don_vi_con") // Tên đơn vị con tại thời điểm chốt
  khoanLuongId Int            @map("khoan_luong_id")
  maKhoan      String         @map("ma_khoan")
  tenKhoan     String         @map("ten_khoan")
  loaiKhoan    LoaiKhoanLuong @map("loai_khoan")
  soTien       Decimal        @map("so_tien") @db.Decimal(15, 0)
  nguon        NguonChiTiet   @map("nguon")
  ngayChot     DateTime       @map("ngay_chot")
  nguoiChot    String         @map("nguoi_chot")
  ngayTao      DateTime       @default(now()) @map("ngay_tao")

  @@index([bangLuongId])
  @@index([nhanVienId])
  @@index([bangLuongId, nhanVienId])
  @@index([phongBanId])
  @@map("snapshot_bang_luong")
}

// ============================================
// PHIẾU ĐIỀU CHỈNH LƯƠNG (SAU KHI CHỐT)
// Dùng để điều chỉnh khi phát hiện sai sót sau khi đã chốt
// ============================================
model PhieuDieuChinh {
  id            Int              @id @default(autoincrement())
  maPhieu       String           @unique @map("ma_phieu")
  bangLuongId   Int              @map("bang_luong_id")
  nhanVienId    Int              @map("nhan_vien_id")
  loaiDieuChinh LoaiDieuChinh    @default(TANG) @map("loai_dieu_chinh")
  lyDo          String           @map("ly_do")
  ghiChu        String?          @map("ghi_chu")
  trangThai     TrangThaiPhieuDC @default(CHO_DUYET) @map("trang_thai")
  nguoiTao      String           @map("nguoi_tao")
  ngayTao       DateTime         @default(now()) @map("ngay_tao")
  nguoiDuyet    String?          @map("nguoi_duyet")
  ngayDuyet     DateTime?        @map("ngay_duyet")
  nguoiTuChoi   String?          @map("nguoi_tu_choi")
  ngayTuChoi    DateTime?        @map("ngay_tu_choi")
  lyDoTuChoi    String?          @map("ly_do_tu_choi")

  // Quan hệ
  nhanVien NhanVien                @relation(fields: [nhanVienId], references: [id])
  chiTiets ChiTietPhieuDieuChinh[]

  @@map("phieu_dieu_chinh")
}

model ChiTietPhieuDieuChinh {
  id               Int      @id @default(autoincrement())
  phieuDieuChinhId Int      @map("phieu_dieu_chinh_id")
  khoanLuongId     Int      @map("khoan_luong_id")
  soTienCu         Decimal  @map("so_tien_cu") @db.Decimal(15, 0)
  soTienMoi        Decimal  @map("so_tien_moi") @db.Decimal(15, 0)
  chenhLech        Decimal  @map("chenh_lech") @db.Decimal(15, 0)
  ghiChu           String?  @map("ghi_chu")
  ngayTao          DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  phieuDieuChinh PhieuDieuChinh @relation(fields: [phieuDieuChinhId], references: [id], onDelete: Cascade)
  khoanLuong     KhoanLuong     @relation(fields: [khoanLuongId], references: [id])

  @@map("chi_tiet_phieu_dieu_chinh")
}

enum LoaiDieuChinh {
  TANG // Điều chỉnh tăng
  GIAM // Điều chỉnh giảm
  THAY_THE // Thay thế hoàn toàn

  @@map("loai_dieu_chinh")
}

enum TrangThaiPhieuDC {
  CHO_DUYET // Chờ duyệt
  DA_DUYET // Đã duyệt, áp dụng vào kỳ sau
  TU_CHOI // Từ chối
  HUY // Đã hủy

  @@map("trang_thai_phieu_dc")
}

// ============================================
// CẤU HÌNH BHXH/THUẾ TNCN (VIỆT NAM)
// Lưu các mức đóng BHXH, thuế suất theo năm
// ============================================
model CauHinhBHXH {
  id                 Int      @id @default(autoincrement())
  nam                Int      @unique // Năm áp dụng
  tyLeBHXH_NV        Decimal  @map("ty_le_bhxh_nv") @db.Decimal(5, 2) // 8%
  tyLeBHXH_DN        Decimal  @map("ty_le_bhxh_dn") @db.Decimal(5, 2) // 17.5%
  tyLeBHYT_NV        Decimal  @map("ty_le_bhyt_nv") @db.Decimal(5, 2) // 1.5%
  tyLeBHYT_DN        Decimal  @map("ty_le_bhyt_dn") @db.Decimal(5, 2) // 3%
  tyLeBHTN_NV        Decimal  @map("ty_le_bhtn_nv") @db.Decimal(5, 2) // 1%
  tyLeBHTN_DN        Decimal  @map("ty_le_bhtn_dn") @db.Decimal(5, 2) // 1%
  luongCoBanToiThieu Decimal  @map("luong_co_ban_toi_thieu") @db.Decimal(15, 0) // Lương tối thiểu vùng
  tranDongBHXH       Decimal  @map("tran_dong_bhxh") @db.Decimal(15, 0) // Trần đóng BHXH (20x lương cơ sở)
  luongCoSo          Decimal  @map("luong_co_so") @db.Decimal(15, 0) // Lương cơ sở (2.34 triệu năm 2025)
  trangThai          Boolean  @default(true) @map("trang_thai")
  ngayTao            DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat        DateTime @updatedAt @map("ngay_cap_nhat")

  @@map("cau_hinh_bhxh")
}

model CauHinhThueTNCN {
  id              Int      @id @default(autoincrement())
  nam             Int      @unique // Năm áp dụng
  giamTruBanThan  Decimal  @map("giam_tru_ban_than") @db.Decimal(15, 0) // 11 triệu
  giamTruPhuThuoc Decimal  @map("giam_tru_phu_thuoc") @db.Decimal(15, 0) // 4.4 triệu/người
  trangThai       Boolean  @default(true) @map("trang_thai")
  ngayTao         DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat     DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  bacThue BacThueTNCN[]

  @@map("cau_hinh_thue_tncn")
}

// Bậc thuế lũy tiến (7 bậc)
model BacThueTNCN {
  id             Int      @id @default(autoincrement())
  cauHinhThueId  Int      @map("cau_hinh_thue_id")
  bac            Int // 1-7
  tuMuc          Decimal  @map("tu_muc") @db.Decimal(15, 0)
  denMuc         Decimal? @map("den_muc") @db.Decimal(15, 0) // null = không giới hạn
  thueSuat       Decimal  @map("thue_suat") @db.Decimal(5, 2) // 5%, 10%, 15%...
  soTienTruNhanh Decimal  @map("so_tien_tru_nhanh") @db.Decimal(15, 0) // Số tiền trừ nhanh
  ngayTao        DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  cauHinhThue CauHinhThueTNCN @relation(fields: [cauHinhThueId], references: [id], onDelete: Cascade)

  @@unique([cauHinhThueId, bac])
  @@map("bac_thue_tncn")
}

// ============================================
// THÔNG TIN PHỤ THUỘC (NGƯỜI PHỤ THUỘC)
// Để tính giảm trừ gia cảnh
// ============================================
model NguoiPhuThuoc {
  id          Int       @id @default(autoincrement())
  nhanVienId  Int       @map("nhan_vien_id")
  hoTen       String    @map("ho_ten")
  ngaySinh    DateTime? @map("ngay_sinh")
  quanHe      String    @map("quan_he") // Con, Bố, Mẹ, Vợ/Chồng
  maSoThue    String?   @map("ma_so_thue") // MST người phụ thuộc
  soCCCD      String?   @map("so_cccd")
  tuNgay      DateTime  @map("tu_ngay") // Ngày bắt đầu tính giảm trừ
  denNgay     DateTime? @map("den_ngay")
  trangThai   Boolean   @default(true) @map("trang_thai")
  ghiChu      String?   @map("ghi_chu")
  ngayTao     DateTime  @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime  @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  nhanVien NhanVien @relation(fields: [nhanVienId], references: [id])

  @@map("nguoi_phu_thuoc")
}

// ============================================
// BẢNG TÍNH BHXH/THUẾ THEO THÁNG
// Lưu kết quả tính cho mỗi nhân viên mỗi tháng
// ============================================
model BangTinhBHXH {
  id            Int      @id @default(autoincrement())
  bangLuongId   Int      @map("bang_luong_id")
  nhanVienId    Int      @map("nhan_vien_id")
  luongDongBHXH Decimal  @map("luong_dong_bhxh") @db.Decimal(15, 0) // Lương làm căn cứ đóng
  bhxhNV        Decimal  @map("bhxh_nv") @db.Decimal(15, 0)
  bhytNV        Decimal  @map("bhyt_nv") @db.Decimal(15, 0)
  bhtnNV        Decimal  @map("bhtn_nv") @db.Decimal(15, 0)
  tongBHNV      Decimal  @map("tong_bh_nv") @db.Decimal(15, 0)
  bhxhDN        Decimal  @map("bhxh_dn") @db.Decimal(15, 0)
  bhytDN        Decimal  @map("bhyt_dn") @db.Decimal(15, 0)
  bhtnDN        Decimal  @map("bhtn_dn") @db.Decimal(15, 0)
  tongBHDN      Decimal  @map("tong_bh_dn") @db.Decimal(15, 0)
  ngayTao       DateTime @default(now()) @map("ngay_tao")

  @@unique([bangLuongId, nhanVienId])
  @@map("bang_tinh_bhxh")
}

model BangTinhThue {
  id              Int      @id @default(autoincrement())
  bangLuongId     Int      @map("bang_luong_id")
  nhanVienId      Int      @map("nhan_vien_id")
  thuNhapChiuThue Decimal  @map("thu_nhap_chiu_thue") @db.Decimal(15, 0)
  giamTruBanThan  Decimal  @map("giam_tru_ban_than") @db.Decimal(15, 0)
  soPhuThuoc      Int      @default(0) @map("so_phu_thuoc")
  giamTruPhuThuoc Decimal  @map("giam_tru_phu_thuoc") @db.Decimal(15, 0)
  giamTruBHXH     Decimal  @map("giam_tru_bhxh") @db.Decimal(15, 0)
  thuNhapTinhThue Decimal  @map("thu_nhap_tinh_thue") @db.Decimal(15, 0)
  thueTNCN        Decimal  @map("thue_tncn") @db.Decimal(15, 0)
  bacThueApDung   Int?     @map("bac_thue_ap_dung")
  ngayTao         DateTime @default(now()) @map("ngay_tao")

  @@unique([bangLuongId, nhanVienId])
  @@map("bang_tinh_thue")
}

// ============================================
// RULE ENGINE - CÔNG THỨC TÍNH LƯƠNG ĐỘNG
// Cho phép định nghĩa công thức tính theo phòng ban
// ============================================
model CongThucLuong {
  id          Int       @id @default(autoincrement())
  maCongThuc  String    @unique @map("ma_cong_thuc")
  tenCongThuc String    @map("ten_cong_thuc")
  moTa        String?   @map("mo_ta")
  phongBanId  Int?      @map("phong_ban_id") // null = áp dụng toàn công ty
  congThuc    String    @map("cong_thuc") @db.Text // Biểu thức công thức
  phienBan    Int       @default(1) @map("phien_ban")
  tuNgay      DateTime  @map("tu_ngay")
  denNgay     DateTime? @map("den_ngay")
  trangThai   Boolean   @default(true) @map("trang_thai")
  nguoiTao    String?   @map("nguoi_tao")
  ngayTao     DateTime  @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime  @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  bienSos BienSoCongThuc[]

  @@map("cong_thuc_luong")
}

// Biến số dùng trong công thức
model BienSoCongThuc {
  id            Int        @id @default(autoincrement())
  congThucId    Int        @map("cong_thuc_id")
  tenBien       String     @map("ten_bien") // LUONG_CO_BAN, PHU_CAP, CONG_THUC_TE...
  moTa          String?    @map("mo_ta")
  kieuDuLieu    KieuDuLieu @default(SO) @map("kieu_du_lieu")
  nguonDuLieu   String?    @map("nguon_du_lieu") // Bảng/trường lấy dữ liệu
  giaTriMacDinh String?    @map("gia_tri_mac_dinh")
  ngayTao       DateTime   @default(now()) @map("ngay_tao")

  // Quan hệ
  congThuc CongThucLuong @relation(fields: [congThucId], references: [id], onDelete: Cascade)

  @@unique([congThucId, tenBien])
  @@map("bien_so_cong_thuc")
}

enum KieuDuLieu {
  SO // Number
  TIEN // Currency (VND)
  PHAN_TRAM // Percentage
  NGAY // Date
  CHUOI // String

  @@map("kieu_du_lieu")
}

// Lịch sử phiên bản công thức
model LichSuCongThuc {
  id           Int      @id @default(autoincrement())
  maCongThuc   String   @map("ma_cong_thuc")
  phienBan     Int      @map("phien_ban")
  congThucCu   String   @map("cong_thuc_cu") @db.Text
  congThucMoi  String   @map("cong_thuc_moi") @db.Text
  lyDoThayDoi  String?  @map("ly_do_thay_doi")
  nguoiThayDoi String   @map("nguoi_thay_doi")
  ngayThayDoi  DateTime @default(now()) @map("ngay_thay_doi")

  @@map("lich_su_cong_thuc")
}

// ============================================
// CHẤM CÔNG
// Quản lý dữ liệu chấm công nhân viên
// ============================================
model ChamCong {
  id                   Int      @id @default(autoincrement())
  nhanVienId           Int      @map("nhan_vien_id")
  thang                Int // 1-12
  nam                  Int
  soCongChuan          Decimal  @default(26) @map("so_cong_chuan") @db.Decimal(5, 1)
  soCongThucTe         Decimal  @default(0) @map("so_cong_thuc_te") @db.Decimal(5, 1)
  soNgayNghiPhep       Decimal  @default(0) @map("so_ngay_nghi_phep") @db.Decimal(5, 1)
  soNgayNghiKhongLuong Decimal  @default(0) @map("so_ngay_nghi_khong_luong") @db.Decimal(5, 1)
  soGioOT              Decimal  @default(0) @map("so_gio_ot") @db.Decimal(5, 1)
  soGioOTDem           Decimal  @default(0) @map("so_gio_ot_dem") @db.Decimal(5, 1)
  soGioOTChuNhat       Decimal  @default(0) @map("so_gio_ot_chu_nhat") @db.Decimal(5, 1)
  soGioOTLe            Decimal  @default(0) @map("so_gio_ot_le") @db.Decimal(5, 1)
  soLanDiMuon          Int      @default(0) @map("so_lan_di_muon")
  soLanVeSom           Int      @default(0) @map("so_lan_ve_som")
  ghiChu               String?  @map("ghi_chu")
  ngayTao              DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat          DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  nhanVien NhanVien @relation(fields: [nhanVienId], references: [id])

  @@unique([nhanVienId, thang, nam])
  @@index([nhanVienId])
  @@index([thang, nam])
  @@map("cham_cong")
}

// Chi tiết chấm công từng ngày
model ChiTietChamCong {
  id         Int               @id @default(autoincrement())
  nhanVienId Int               @map("nhan_vien_id")
  ngay       DateTime          @map("ngay")
  gioVao     DateTime?         @map("gio_vao")
  gioRa      DateTime?         @map("gio_ra")
  loaiNgay   LoaiNgayCong      @default(NGAY_THUONG) @map("loai_ngay")
  trangThai  TrangThaiChamCong @default(DI_LAM) @map("trang_thai")
  soGioLam   Decimal           @default(0) @map("so_gio_lam") @db.Decimal(5, 2)
  soGioOT    Decimal           @default(0) @map("so_gio_ot") @db.Decimal(5, 2)
  ghiChu     String?           @map("ghi_chu")
  ngayTao    DateTime          @default(now()) @map("ngay_tao")

  // === XẾP CA: Liên kết ca làm việc ===
  caLamViecId  Int?      @map("ca_lam_viec_id") // Ca được phân cho ngày này
  gioVaoDuKien DateTime? @map("gio_vao_du_kien") // Giờ vào theo ca (denormalize)
  gioRaDuKien  DateTime? @map("gio_ra_du_kien") // Giờ ra theo ca (denormalize)
  phutDiTre    Int?      @map("phut_di_tre") // Số phút đi trễ so với ca
  phutVeSom    Int?      @map("phut_ve_som") // Số phút về sớm so với ca

  // Quan hệ
  caLamViec CaLamViec? @relation(fields: [caLamViecId], references: [id])

  @@unique([nhanVienId, ngay])
  @@index([nhanVienId])
  @@index([ngay])
  @@index([caLamViecId])
  @@map("chi_tiet_cham_cong")
}

enum LoaiNgayCong {
  NGAY_THUONG
  THU_BAY
  CHU_NHAT
  NGAY_LE

  @@map("loai_ngay_cong")
}

enum TrangThaiChamCong {
  DI_LAM
  NGHI_PHEP
  NGHI_KHONG_LUONG
  NGHI_LE
  NGHI_BENH
  CONG_TAC
  LAM_TU_XA

  @@map("trang_thai_cham_cong")
}

// ============================================
// CẤU HÌNH PHẠT CHẤM CÔNG
// Quy định mức phạt đi muộn, về sớm, nghỉ không phép
// ============================================
model CauHinhPhatChamCong {
  id  Int @id @default(autoincrement())
  nam Int @unique // Năm áp dụng

  // Phạt đi muộn (theo số lần trong tháng)
  phatDiMuon1_3Lan   Decimal @default(0) @map("phat_di_muon_1_3_lan") @db.Decimal(15, 0) // 1-3 lần
  phatDiMuon4_6Lan   Decimal @default(0) @map("phat_di_muon_4_6_lan") @db.Decimal(15, 0) // 4-6 lần
  phatDiMuonTren6Lan Decimal @default(0) @map("phat_di_muon_tren_6_lan") @db.Decimal(15, 0) // >6 lần

  // Phạt về sớm (theo số lần trong tháng)
  phatVeSom1_3Lan   Decimal @default(0) @map("phat_ve_som_1_3_lan") @db.Decimal(15, 0)
  phatVeSom4_6Lan   Decimal @default(0) @map("phat_ve_som_4_6_lan") @db.Decimal(15, 0)
  phatVeSomTren6Lan Decimal @default(0) @map("phat_ve_som_tren_6_lan") @db.Decimal(15, 0)

  // Phạt nghỉ không phép (theo ngày)
  phatNghiKhongPhep     Decimal @default(0) @map("phat_nghi_khong_phep") @db.Decimal(15, 0) // Tiền/ngày
  truLuongNghiKhongPhep Boolean @default(true) @map("tru_luong_nghi_khong_phep") // Trừ theo ngày công

  // Giờ làm việc chuẩn
  gioVaoChuan    String @default("08:00") @map("gio_vao_chuan")
  gioRaChuan     String @default("17:00") @map("gio_ra_chuan")
  phutChoPhepTre Int    @default(5) @map("phut_cho_phep_tre") // Phút được phép trễ

  moTa        String?  @map("mo_ta")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  @@map("cau_hinh_phat_cham_cong")
}

// ============================================
// MODULE KPI & THƯỞNG
// Quản lý đánh giá KPI và tính thưởng tự động
// ============================================

// Template KPI theo phòng ban
model TemplateKPI {
  id          Int      @id @default(autoincrement())
  maTemplate  String   @unique @map("ma_template")
  tenTemplate String   @map("ten_template")
  phongBanId  Int?     @map("phong_ban_id") // null = áp dụng toàn công ty
  moTa        String?  @map("mo_ta")
  trangThai   Boolean  @default(true) @map("trang_thai")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  chiTieuKPIs ChiTieuKPI[]

  @@map("template_kpi")
}

// Chi tiêu KPI trong template
model ChiTieuKPI {
  id              Int            @id @default(autoincrement())
  templateId      Int            @map("template_id")
  maChiTieu       String         @map("ma_chi_tieu")
  tenChiTieu      String         @map("ten_chi_tieu")
  moTa            String?        @map("mo_ta")
  donViTinh       String         @map("don_vi_tinh") // %, số, VNĐ
  trongSo         Decimal        @map("trong_so") @db.Decimal(5, 2) // % trọng số (tổng = 100%)
  loaiChiTieu     LoaiChiTieuKPI @default(SO) @map("loai_chi_tieu")
  chiTieuToiThieu Decimal?       @map("chi_tieu_toi_thieu") @db.Decimal(15, 2)
  chiTieuMucTieu  Decimal?       @map("chi_tieu_muc_tieu") @db.Decimal(15, 2)
  chiTieuVuotMuc  Decimal?       @map("chi_tieu_vuot_muc") @db.Decimal(15, 2)
  thuTu           Int            @default(0) @map("thu_tu")
  ngayTao         DateTime       @default(now()) @map("ngay_tao")

  // Quan hệ
  template   TemplateKPI @relation(fields: [templateId], references: [id], onDelete: Cascade)
  ketQuaKPIs KetQuaKPI[]

  @@unique([templateId, maChiTieu])
  @@map("chi_tieu_kpi")
}

enum LoaiChiTieuKPI {
  SO // Số lượng cụ thể
  PHAN_TRAM // Phần trăm
  TIEN // Doanh số, doanh thu
  THOI_GIAN // Giờ, ngày
  DANH_GIA // Đánh giá từ 1-5

  @@map("loai_chi_tieu_kpi")
}

// Kỳ đánh giá KPI
model KyDanhGiaKPI {
  id           Int                @id @default(autoincrement())
  maKy         String             @unique @map("ma_ky") // KPI-2025-Q1, KPI-2025-01
  tenKy        String             @map("ten_ky")
  loaiKy       LoaiKyDanhGia      @default(THANG) @map("loai_ky")
  thang        Int? // Nếu là kỳ tháng
  quy          Int? // Nếu là kỳ quý (1-4)
  nam          Int
  tuNgay       DateTime           @map("tu_ngay")
  denNgay      DateTime           @map("den_ngay")
  hanNopKetQua DateTime           @map("han_nop_ket_qua")
  trangThai    TrangThaiKyDanhGia @default(MO) @map("trang_thai")
  ghiChu       String?            @map("ghi_chu")
  ngayTao      DateTime           @default(now()) @map("ngay_tao")
  ngayCapNhat  DateTime           @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  danhGiaNhanViens DanhGiaKPINhanVien[]

  @@map("ky_danh_gia_kpi")
}

enum LoaiKyDanhGia {
  THANG
  QUY
  NAM

  @@map("loai_ky_danh_gia")
}

enum TrangThaiKyDanhGia {
  MO // Đang mở để nhập
  DONG // Đã đóng nhập liệu
  DUYET // Đã duyệt kết quả
  HOAN_THANH // Hoàn thành (đã tính thưởng)

  @@map("trang_thai_ky_danh_gia")
}

// Đánh giá KPI của từng nhân viên
model DanhGiaKPINhanVien {
  id           Int                 @id @default(autoincrement())
  kyDanhGiaId  Int                 @map("ky_danh_gia_id")
  nhanVienId   Int                 @map("nhan_vien_id")
  templateId   Int                 @map("template_id")
  diemTongKet  Decimal?            @map("diem_tong_ket") @db.Decimal(5, 2) // 0-100
  xepLoai      XepLoaiKPI?         @map("xep_loai")
  heSoThuong   Decimal             @default(0) @map("he_so_thuong") @db.Decimal(5, 2)
  soTienThuong Decimal             @default(0) @map("so_tien_thuong") @db.Decimal(15, 0)
  nhanXetChung String?             @map("nhan_xet_chung")
  nguoiDanhGia String?             @map("nguoi_danh_gia")
  ngayDanhGia  DateTime?           @map("ngay_danh_gia")
  nguoiDuyet   String?             @map("nguoi_duyet")
  ngayDuyet    DateTime?           @map("ngay_duyet")
  trangThai    TrangThaiDanhGiaKPI @default(NHAP) @map("trang_thai")
  ngayTao      DateTime            @default(now()) @map("ngay_tao")
  ngayCapNhat  DateTime            @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  kyDanhGia  KyDanhGiaKPI @relation(fields: [kyDanhGiaId], references: [id])
  ketQuaKPIs KetQuaKPI[]

  @@unique([kyDanhGiaId, nhanVienId])
  @@map("danh_gia_kpi_nhan_vien")
}

enum XepLoaiKPI {
  XUAT_SAC // >= 95%
  TOT // >= 80%
  KHA // >= 65%
  TRUNG_BINH // >= 50%
  YEU // < 50%

  @@map("xep_loai_kpi")
}

enum TrangThaiDanhGiaKPI {
  NHAP // Đang nhập
  CHO_DUYET // Chờ duyệt
  DA_DUYET // Đã duyệt
  TU_CHOI // Từ chối

  @@map("trang_thai_danh_gia_kpi")
}

// Kết quả từng chỉ tiêu KPI
model KetQuaKPI {
  id         Int      @id @default(autoincrement())
  danhGiaId  Int      @map("danh_gia_id")
  chiTieuId  Int      @map("chi_tieu_id")
  ketQuaDat  Decimal? @map("ket_qua_dat") @db.Decimal(15, 2)
  tyLeDat    Decimal? @map("ty_le_dat") @db.Decimal(5, 2) // 0-150%
  diemQuyDoi Decimal? @map("diem_quy_doi") @db.Decimal(5, 2)
  ghiChu     String?  @map("ghi_chu")
  ngayTao    DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  danhGia DanhGiaKPINhanVien @relation(fields: [danhGiaId], references: [id], onDelete: Cascade)
  chiTieu ChiTieuKPI         @relation(fields: [chiTieuId], references: [id])

  @@unique([danhGiaId, chiTieuId])
  @@map("ket_qua_kpi")
}

// Cấu hình hệ số thưởng theo xếp loại
model CauHinhThuongKPI {
  id           Int        @id @default(autoincrement())
  nam          Int
  xepLoai      XepLoaiKPI @map("xep_loai")
  diemToiThieu Decimal    @map("diem_toi_thieu") @db.Decimal(5, 2)
  diemToiDa    Decimal    @map("diem_toi_da") @db.Decimal(5, 2)
  heSoThuong   Decimal    @map("he_so_thuong") @db.Decimal(5, 2) // 0.5x, 1x, 1.5x, 2x
  moTa         String?    @map("mo_ta")
  trangThai    Boolean    @default(true) @map("trang_thai")
  ngayTao      DateTime   @default(now()) @map("ngay_tao")

  @@unique([nam, xepLoai])
  @@map("cau_hinh_thuong_kpi")
}

// ============================================
// MODULE RBAC & AUDIT
// Phân quyền và theo dõi hành động
// ============================================

// Người dùng hệ thống
model NguoiDung {
  id              Int                @id @default(autoincrement())
  tenDangNhap     String             @unique @map("ten_dang_nhap")
  matKhau         String             @map("mat_khau") // Hashed
  email           String             @unique
  hoTen           String             @map("ho_ten")
  nhanVienId      Int?               @unique @map("nhan_vien_id") // Liên kết với nhân viên nếu có
  trangThai       TrangThaiNguoiDung @default(HOAT_DONG) @map("trang_thai")
  lanDangNhapCuoi DateTime?          @map("lan_dang_nhap_cuoi")
  ngayTao         DateTime           @default(now()) @map("ngay_tao")
  ngayCapNhat     DateTime           @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  vaiTros           NguoiDungVaiTro[]
  auditLogs         AuditLog[]
  phienDangNhaps    PhienDangNhap[]
  aiRuleAudits      AiRuleAudit[]
  lichSuImports     LichSuImport[]
  auditSuaDuLieus   AuditSuaDuLieu[]
  // Module nghỉ phép
  donNghiPhepsDuyet DonNghiPhep[]     @relation("NguoiDuyetDon")
  // Module yêu cầu (Sprint 4)
  donYeuCausDuyet1  DonYeuCau[]       @relation("NguoiDuyet1")
  donYeuCausDuyet2  DonYeuCau[]       @relation("NguoiDuyet2")
  donYeuCausOverride DonYeuCau[]      @relation("NguoiOverride")
  // Sprint 6: Thông báo
  thongBaos         ThongBao[]

  @@map("nguoi_dung")
}

enum TrangThaiNguoiDung {
  HOAT_DONG
  TAM_KHOA
  VO_HIEU_HOA

  @@map("trang_thai_nguoi_dung")
}

// Vai trò (Role)
model VaiTro {
  id        Int      @id @default(autoincrement())
  maVaiTro  String   @unique @map("ma_vai_tro") // ADMIN, HR, ACCOUNTANT, EMPLOYEE
  tenVaiTro String   @map("ten_vai_tro")
  moTa      String?  @map("mo_ta")
  capDo     Int      @default(0) @map("cap_do") // 0 = thấp nhất
  trangThai Boolean  @default(true) @map("trang_thai")
  ngayTao   DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  nguoiDungs NguoiDungVaiTro[]
  quyens     VaiTroQuyen[]

  @@map("vai_tro")
}

// Liên kết người dùng - vai trò (many-to-many)
model NguoiDungVaiTro {
  id          Int       @id @default(autoincrement())
  nguoiDungId Int       @map("nguoi_dung_id")
  vaiTroId    Int       @map("vai_tro_id")
  phongBanId  Int?      @map("phong_ban_id") // null = toàn công ty
  tuNgay      DateTime  @default(now()) @map("tu_ngay")
  denNgay     DateTime? @map("den_ngay")
  ngayTao     DateTime  @default(now()) @map("ngay_tao")

  // Quan hệ
  nguoiDung NguoiDung @relation(fields: [nguoiDungId], references: [id], onDelete: Cascade)
  vaiTro    VaiTro    @relation(fields: [vaiTroId], references: [id])

  @@unique([nguoiDungId, vaiTroId, phongBanId])
  @@map("nguoi_dung_vai_tro")
}

// Quyền (Permission)
model Quyen {
  id        Int      @id @default(autoincrement())
  maQuyen   String   @unique @map("ma_quyen") // LUONG_XEM, LUONG_SUA, NHAN_VIEN_TAO...
  tenQuyen  String   @map("ten_quyen")
  nhomQuyen String   @map("nhom_quyen") // LUONG, NHAN_VIEN, KPI...
  moTa      String?  @map("mo_ta")
  ngayTao   DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  vaiTros VaiTroQuyen[]

  @@map("quyen")
}

// Liên kết vai trò - quyền
model VaiTroQuyen {
  id       Int      @id @default(autoincrement())
  vaiTroId Int      @map("vai_tro_id")
  quyenId  Int      @map("quyen_id")
  ngayTao  DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  vaiTro VaiTro @relation(fields: [vaiTroId], references: [id], onDelete: Cascade)
  quyen  Quyen  @relation(fields: [quyenId], references: [id])

  @@unique([vaiTroId, quyenId])
  @@map("vai_tro_quyen")
}

// Audit Log - Ghi lại mọi hành động
model AuditLog {
  id          Int           @id @default(autoincrement())
  nguoiDungId Int?          @map("nguoi_dung_id")
  tenDangNhap String        @map("ten_dang_nhap")
  hanhDong    HanhDongAudit @map("hanh_dong")
  bangDuLieu  String        @map("bang_du_lieu") // Tên bảng bị thay đổi
  banGhiId    String?       @map("ban_ghi_id") // ID bản ghi
  duLieuCu    String?       @map("du_lieu_cu") @db.Text // JSON
  duLieuMoi   String?       @map("du_lieu_moi") @db.Text // JSON
  diaChiIP    String?       @map("dia_chi_ip")
  userAgent   String?       @map("user_agent")
  moTa        String?       @map("mo_ta")
  ngayTao     DateTime      @default(now()) @map("ngay_tao")

  // Quan hệ
  nguoiDung NguoiDung? @relation(fields: [nguoiDungId], references: [id], onDelete: SetNull)

  @@index([nguoiDungId])
  @@index([bangDuLieu])
  @@index([ngayTao])
  @@map("audit_log")
}

enum HanhDongAudit {
  TAO_MOI
  CAP_NHAT
  XOA
  DANG_NHAP
  DANG_XUAT
  CHOT_LUONG
  MO_KHOA
  DUYET
  TU_CHOI
  IMPORT
  EXPORT
  CHAY_RULE_ENGINE

  @@map("hanh_dong_audit")
}

// Phiên đăng nhập
model PhienDangNhap {
  id             Int            @id @default(autoincrement())
  nguoiDungId    Int            @map("nguoi_dung_id")
  token          String         @unique
  diaChiIP       String?        @map("dia_chi_ip")
  userAgent      String?        @map("user_agent")
  thoiGianBatDau DateTime       @default(now()) @map("thoi_gian_bat_dau")
  thoiGianHetHan DateTime       @map("thoi_gian_het_han")
  trangThai      TrangThaiPhien @default(HOAT_DONG) @map("trang_thai")

  // Quan hệ
  nguoiDung NguoiDung @relation(fields: [nguoiDungId], references: [id], onDelete: Cascade)

  @@index([nguoiDungId])
  @@index([thoiGianHetHan])
  @@map("phien_dang_nhap")
}

enum TrangThaiPhien {
  HOAT_DONG
  HET_HAN
  DANG_XUAT

  @@map("trang_thai_phien")
}

// ============================================
// THÔNG TIN CÔNG TY
// Lưu thông tin công ty để hiển thị trên phiếu lương
// ============================================
model ThongTinCongTy {
  id                   Int      @id @default(autoincrement())
  tenCongTy            String   @map("ten_cong_ty")
  maSoThue             String?  @map("ma_so_thue")
  diaChi               String?  @map("dia_chi")
  dienThoai            String?  @map("dien_thoai")
  email                String?  @map("email")
  website              String?  @map("website")
  logo                 String?  @map("logo") // URL hoặc path đến logo
  nguoiDaiDien         String?  @map("nguoi_dai_dien")
  chucVuDaiDien        String?  @map("chuc_vu_dai_dien")
  ngayCongChuanMacDinh Int      @default(26) @map("ngay_cong_chuan_mac_dinh") // Số ngày công chuẩn mặc định
  ngayTao              DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat          DateTime @updatedAt @map("ngay_cap_nhat")

  @@map("thong_tin_cong_ty")
}

// ============================================
// RULE ENGINE - QUY CHẾ LƯƠNG THEO PHÒNG BAN
// Quản lý quy chế lương có version theo thời gian
// ============================================
model QuyChe {
  id          Int             @id @default(autoincrement())
  phongBanId  Int             @map("phong_ban_id")
  tenQuyChe   String          @map("ten_quy_che")
  moTa        String?         @map("mo_ta")
  tuNgay      DateTime        @map("tu_ngay")
  denNgay     DateTime?       @map("den_ngay")
  phienBan    Int             @default(1) @map("phien_ban")
  trangThai   TrangThaiQuyChe @default(HIEU_LUC) @map("trang_thai")
  nguoiTao    String?         @map("nguoi_tao")
  ngayTao     DateTime        @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime        @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  phongBan     PhongBan          @relation(fields: [phongBanId], references: [id])
  rules        QuyCheRule[]
  bangLuongs   BangLuongQuyChe[]
  ruleTraces   RuleTrace[]
  aiRuleAudits AiRuleAudit[]

  @@index([phongBanId])
  @@index([tuNgay, denNgay])
  @@index([trangThai])
  @@map("quy_che")
}

enum TrangThaiQuyChe {
  NHAP // Đang soạn thảo
  HIEU_LUC // Đang áp dụng
  TAM_DUNG // Tạm dừng
  NGUNG // Ngừng áp dụng

  @@map("trang_thai_quy_che")
}

// ============================================
// RULE CẤU HÌNH TRONG QUY CHẾ
// Mỗi rule định nghĩa cách tính 1 khoản lương
// ============================================
model QuyCheRule {
  id              Int      @id @default(autoincrement())
  quyCheId        Int      @map("quy_che_id")
  khoanLuongId    Int      @map("khoan_luong_id")
  tenRule         String   @map("ten_rule")
  moTa            String?  @map("mo_ta")
  loaiRule        LoaiRule @map("loai_rule")
  dieuKienJson    String?  @map("dieu_kien_json") @db.Text // JSON điều kiện áp dụng
  congThucJson    String   @map("cong_thuc_json") @db.Text // JSON mô tả cách tính
  thuTuUuTien     Int      @default(0) @map("thu_tu_uu_tien")
  cheDoGop        CheDoGop @default(GHI_DE) @map("che_do_gop")
  choPhepChinhTay Boolean  @default(true) @map("cho_phep_chinh_tay")
  trangThai       Boolean  @default(true) @map("trang_thai")
  nguoiTao        String?  @map("nguoi_tao")
  ngayTao         DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat     DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  quyChe       QuyChe        @relation(fields: [quyCheId], references: [id], onDelete: Cascade)
  khoanLuong   KhoanLuong    @relation(fields: [khoanLuongId], references: [id])
  ruleTraces   RuleTrace[]
  aiRuleAudits AiRuleAudit[]

  @@index([quyCheId])
  @@index([khoanLuongId])
  @@index([thuTuUuTien])
  @@map("quy_che_rule")
}

enum LoaiRule {
  CO_DINH // Số tiền cố định
  THEO_HE_SO // Theo hệ số × base
  BAC_THANG // Theo bậc thang điều kiện
  THEO_SU_KIEN // Theo sự kiện thưởng/phạt
  CONG_THUC // Biểu thức công thức

  @@map("loai_rule")
}

enum CheDoGop {
  CONG_DON // Cộng dồn nhiều lần
  GHI_DE // Ghi đè theo ưu tiên

  @@map("che_do_gop")
}

// ============================================
// NHÂN VIÊN TRÁCH NHIỆM
// Cấp trách nhiệm, hệ số, vai trò của nhân viên
// ============================================
model NhanVienTrachNhiem {
  id             Int       @id @default(autoincrement())
  nhanVienId     Int       @map("nhan_vien_id")
  phongBanId     Int       @map("phong_ban_id")
  capTrachNhiem  Int       @default(1) @map("cap_trach_nhiem") // 1, 2, 3...
  heSoTrachNhiem Decimal   @default(1) @map("he_so_trach_nhiem") @db.Decimal(5, 2)
  vaiTro         String?   @map("vai_tro") // TO_TRUONG, QUAN_LY, GIAM_DOC...
  tuNgay         DateTime  @map("tu_ngay")
  denNgay        DateTime? @map("den_ngay")
  ghiChu         String?   @map("ghi_chu")
  ngayTao        DateTime  @default(now()) @map("ngay_tao")
  ngayCapNhat    DateTime  @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  nhanVien NhanVien @relation(fields: [nhanVienId], references: [id])
  phongBan PhongBan @relation(fields: [phongBanId], references: [id])

  @@index([nhanVienId])
  @@index([phongBanId])
  @@index([tuNgay, denNgay])
  @@map("nhan_vien_trach_nhiem")
}

// ============================================
// SỰ KIỆN THƯỞNG/PHẠT
// Ghi nhận các sự kiện thưởng/phạt phát sinh
// ============================================
model SuKienThuongPhat {
  id          Int             @id @default(autoincrement())
  nhanVienId  Int             @map("nhan_vien_id")
  phongBanId  Int             @map("phong_ban_id")
  ngay        DateTime
  loaiSuKien  LoaiSuKien      @map("loai_su_kien")
  maSuKien    String          @map("ma_su_kien") // DI_TRE, SAI_QUY_TRINH, HOAN_THANH_XUAT_SAC...
  giaTri      Decimal         @default(0) @map("gia_tri") @db.Decimal(15, 2) // Số lần/điểm/số tiền
  soTien      Decimal         @default(0) @map("so_tien") @db.Decimal(15, 0) // Số tiền quy đổi
  ghiChu      String?         @map("ghi_chu")
  trangThai   TrangThaiSuKien @default(NHAP) @map("trang_thai")
  duyetBoi    String?         @map("duyet_boi")
  duyetLuc    DateTime?       @map("duyet_luc")
  nguoiTao    String?         @map("nguoi_tao")
  ngayTao     DateTime        @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime        @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  nhanVien NhanVien @relation(fields: [nhanVienId], references: [id])
  phongBan PhongBan @relation(fields: [phongBanId], references: [id])

  @@index([nhanVienId])
  @@index([phongBanId])
  @@index([ngay])
  @@index([loaiSuKien])
  @@index([trangThai])
  @@map("su_kien_thuong_phat")
}

enum LoaiSuKien {
  THUONG // Thưởng
  PHAT // Phạt

  @@map("loai_su_kien")
}

enum TrangThaiSuKien {
  NHAP // Đang nhập
  DA_DUYET // Đã duyệt
  TU_CHOI // Từ chối
  HUY // Đã hủy

  @@map("trang_thai_su_kien")
}

// ============================================
// DANH MỤC SỰ KIỆN
// Định nghĩa các loại sự kiện thưởng/phạt
// ============================================
model DanhMucSuKien {
  id            Int        @id @default(autoincrement())
  maSuKien      String     @unique @map("ma_su_kien")
  tenSuKien     String     @map("ten_su_kien")
  loai          LoaiSuKien
  moTa          String?    @map("mo_ta")
  soTienMacDinh Decimal?   @map("so_tien_mac_dinh") @db.Decimal(15, 0)
  trangThai     Boolean    @default(true) @map("trang_thai")
  ngayTao       DateTime   @default(now()) @map("ngay_tao")
  ngayCapNhat   DateTime   @updatedAt @map("ngay_cap_nhat")

  @@map("danh_muc_su_kien")
}

// ============================================
// LIÊN KẾT BẢNG LƯƠNG - QUY CHẾ
// Ghi nhận quy chế đã áp dụng cho bảng lương
// ============================================
model BangLuongQuyChe {
  id          Int      @id @default(autoincrement())
  bangLuongId Int      @map("bang_luong_id")
  quyCheId    Int      @map("quy_che_id")
  ngayApDung  DateTime @default(now()) @map("ngay_ap_dung")
  nguoiApDung String?  @map("nguoi_ap_dung")
  ngayTao     DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  bangLuong BangLuong @relation(fields: [bangLuongId], references: [id], onDelete: Cascade)
  quyChe    QuyChe    @relation(fields: [quyCheId], references: [id])

  @@unique([bangLuongId, quyCheId])
  @@map("bang_luong_quy_che")
}

// ============================================
// RULE TRACE - GIẢI TRÌNH TÍNH TOÁN
// Lưu lại trace khi rule engine chạy
// ============================================
model RuleTrace {
  id               Int      @id @default(autoincrement())
  bangLuongId      Int      @map("bang_luong_id")
  nhanVienId       Int      @map("nhan_vien_id")
  quyCheId         Int      @map("quy_che_id")
  quyCheRuleId     Int?     @map("quy_che_rule_id")
  khoanLuongId     Int      @map("khoan_luong_id")
  inputJson        String   @map("input_json") @db.Text // Dữ liệu đầu vào
  outputSoTien     Decimal  @map("output_so_tien") @db.Decimal(15, 0)
  messageGiaiThich String   @map("message_giai_thich") @db.Text // Giải thích cách tính
  taoLuc           DateTime @default(now()) @map("tao_luc")

  // Quan hệ
  bangLuong  BangLuong   @relation(fields: [bangLuongId], references: [id], onDelete: Cascade)
  nhanVien   NhanVien    @relation(fields: [nhanVienId], references: [id])
  quyChe     QuyChe      @relation(fields: [quyCheId], references: [id])
  quyCheRule QuyCheRule? @relation(fields: [quyCheRuleId], references: [id], onDelete: SetNull)
  khoanLuong KhoanLuong  @relation(fields: [khoanLuongId], references: [id])

  @@index([bangLuongId])
  @@index([nhanVienId])
  @@index([quyCheId])
  @@index([taoLuc])
  @@index([bangLuongId, nhanVienId]) // Composite index for common query pattern
  @@map("rule_trace")
}

// ============================================
// AI RULE AUDIT - LỊCH SỬ GỢI Ý RULE TỪ AI
// Lưu lại mọi prompt và response từ trợ lý AI
// ============================================
model AiRuleAudit {
  id           Int              @id @default(autoincrement())
  nguoiTaoId   Int?             @map("nguoi_tao_id")
  phongBanId   Int?             @map("phong_ban_id")
  quyCheId     Int?             @map("quy_che_id")
  promptGoc    String           @map("prompt_goc") @db.Text // Nội dung tiếng Việt user nhập
  responseJson String           @map("response_json") @db.Text // Kết quả JSON từ AI
  trangThai    TrangThaiAiAudit @default(DE_XUAT) @map("trang_thai")
  ruleApDungId Int?             @map("rule_ap_dung_id") // ID rule nếu đã áp dụng
  taoLuc       DateTime         @default(now()) @map("tao_luc")

  // Quan hệ
  nguoiTao NguoiDung?  @relation(fields: [nguoiTaoId], references: [id])
  phongBan PhongBan?   @relation(fields: [phongBanId], references: [id])
  quyChe   QuyChe?     @relation(fields: [quyCheId], references: [id])
  rule     QuyCheRule? @relation(fields: [ruleApDungId], references: [id], onDelete: SetNull)

  @@index([nguoiTaoId])
  @@index([quyCheId])
  @@index([trangThai])
  @@index([taoLuc])
  @@map("ai_rule_audit")
}

enum TrangThaiAiAudit {
  DE_XUAT
  DA_AP_DUNG
  HUY

  @@map("trang_thai_ai_audit")
}

// ============================================
// MODULE CHIA HÀNG & GIAO HÀNG
// Import Excel sản lượng hằng ngày
// ============================================

enum LoaiImport {
  CHIA_HANG
  GIAO_HANG

  @@map("loai_import")
}

enum TrangThaiImport {
  THANH_CONG
  THAT_BAI

  @@map("trang_thai_import")
}

enum NguonDuLieu {
  IMPORT_EXCEL
  ADMIN_SUA
  NHAP_TAY

  @@map("nguon_du_lieu")
}

// Lịch sử Import
model LichSuImport {
  id             Int             @id @default(autoincrement())
  loaiImport     LoaiImport      @map("loai_import")
  ngayDuLieu     DateTime        @map("ngay_du_lieu") @db.Date
  tenFile        String          @map("ten_file")
  fileHash       String?         @map("file_hash")
  soDong         Int             @map("so_dong")
  soDongHopLe    Int             @map("so_dong_hop_le")
  soDongLoi      Int             @map("so_dong_loi")
  trangThai      TrangThaiImport @map("trang_thai")
  nguoiImportId  Int             @map("nguoi_import_id")
  importLuc      DateTime        @default(now()) @map("import_luc")
  noiDungLoiJson String?         @map("noi_dung_loi_json") @db.Text

  // Quan hệ
  nguoiImport       NguoiDung          @relation(fields: [nguoiImportId], references: [id])
  sanLuongChiaHangs SanLuongChiaHang[]
  giaoHangs         GiaoHang[]

  @@index([loaiImport])
  @@index([ngayDuLieu])
  @@index([nguoiImportId])
  @@index([importLuc])
  @@map("lich_su_import")
}

// Sản lượng Chia hàng
model SanLuongChiaHang {
  id           Int         @id @default(autoincrement())
  ngay         DateTime    @db.Date
  nhanVienId   Int         @map("nhan_vien_id")
  soLuongSpDat Int         @default(0) @map("so_luong_sp_dat")
  soLuongSpLoi Int         @default(0) @map("so_luong_sp_loi")
  ghiChu       String?     @map("ghi_chu")
  nguonDuLieu  NguonDuLieu @default(IMPORT_EXCEL) @map("nguon_du_lieu")
  importId     Int?        @map("import_id")
  khoaSua      Boolean     @default(true) @map("khoa_sua")
  taoBoi       Int?        @map("tao_boi")
  taoLuc       DateTime    @default(now()) @map("tao_luc")
  capNhatBoi   Int?        @map("cap_nhat_boi")
  capNhatLuc   DateTime    @updatedAt @map("cap_nhat_luc")

  // Quan hệ
  nhanVien     NhanVien?     @relation(fields: [nhanVienId], references: [id])
  lichSuImport LichSuImport? @relation(fields: [importId], references: [id])

  @@unique([ngay, nhanVienId])
  @@index([ngay])
  @@index([nhanVienId])
  @@index([importId])
  @@map("san_luong_chia_hang")
}

// Giao hàng
model GiaoHang {
  id                 Int         @id @default(autoincrement())
  ngay               DateTime    @db.Date
  nhanVienId         Int         @map("nhan_vien_id")
  khoiLuongThanhCong Decimal     @default(0) @map("khoi_luong_thanh_cong") @db.Decimal(15, 2)
  soLanTreGio        Int         @default(0) @map("so_lan_tre_gio")
  soLanKhongLayPhieu Int         @default(0) @map("so_lan_khong_lay_phieu")
  ghiChu             String?     @map("ghi_chu")
  nguonDuLieu        NguonDuLieu @default(IMPORT_EXCEL) @map("nguon_du_lieu")
  importId           Int?        @map("import_id")
  khoaSua            Boolean     @default(true) @map("khoa_sua")
  taoBoi             Int?        @map("tao_boi")
  taoLuc             DateTime    @default(now()) @map("tao_luc")
  capNhatBoi         Int?        @map("cap_nhat_boi")
  capNhatLuc         DateTime    @updatedAt @map("cap_nhat_luc")

  // Quan hệ
  nhanVien     NhanVien?     @relation(fields: [nhanVienId], references: [id])
  lichSuImport LichSuImport? @relation(fields: [importId], references: [id])

  @@unique([ngay, nhanVienId])
  @@index([ngay])
  @@index([nhanVienId])
  @@index([importId])
  @@map("giao_hang")
}

// Audit sửa dữ liệu (cho Admin)
model AuditSuaDuLieu {
  id              Int        @id @default(autoincrement())
  loaiDuLieu      LoaiImport @map("loai_du_lieu") // CHIA_HANG / GIAO_HANG
  banGhiId        Int        @map("ban_ghi_id")
  duLieuTruocJson String     @map("du_lieu_truoc_json") @db.Text
  duLieuSauJson   String     @map("du_lieu_sau_json") @db.Text
  lyDo            String     @map("ly_do")
  suaBoi          Int        @map("sua_boi")
  suaLuc          DateTime   @default(now()) @map("sua_luc")

  // Quan hệ
  nguoiSua NguoiDung @relation(fields: [suaBoi], references: [id])

  @@index([loaiDuLieu])
  @@index([banGhiId])
  @@index([suaBoi])
  @@index([suaLuc])
  @@map("audit_sua_du_lieu")
}

// Snapshot sản lượng chia hàng theo kỳ lương
model SnapshotSanLuongChiaHang {
  id          Int @id @default(autoincrement())
  bangLuongId Int @map("bang_luong_id")
  nhanVienId  Int @map("nhan_vien_id")
  tongSpDat   Int @default(0) @map("tong_sp_dat")
  tongSpLoi   Int @default(0) @map("tong_sp_loi")

  // Quan hệ
  bangLuong BangLuong @relation(fields: [bangLuongId], references: [id], onDelete: Cascade)

  @@unique([bangLuongId, nhanVienId])
  @@index([bangLuongId])
  @@index([nhanVienId])
  @@map("snapshot_san_luong_chia_hang")
}

// Snapshot giao hàng theo kỳ lương
model SnapshotGiaoHang {
  id                     Int     @id @default(autoincrement())
  bangLuongId            Int     @map("bang_luong_id")
  nhanVienId             Int     @map("nhan_vien_id")
  tongKhoiLuongThanhCong Decimal @default(0) @map("tong_khoi_luong_thanh_cong") @db.Decimal(15, 2)
  tongSoLanTreGio        Int     @default(0) @map("tong_so_lan_tre_gio")
  tongSoLanKhongLayPhieu Int     @default(0) @map("tong_so_lan_khong_lay_phieu")

  // Quan hệ
  bangLuong BangLuong @relation(fields: [bangLuongId], references: [id], onDelete: Cascade)

  @@unique([bangLuongId, nhanVienId])
  @@index([bangLuongId])
  @@index([nhanVienId])
  @@map("snapshot_giao_hang")
}

// ============================================
// HỢP ĐỒNG / LƯƠNG THEO THỜI GIAN (CỰC QUAN TRỌNG)
// Quản lý lịch sử lương theo hợp đồng
// ============================================
model NhanVienHopDong {
  id           Int              @id @default(autoincrement())
  nhanVienId   Int              @map("nhan_vien_id")
  loaiHopDong  LoaiHopDong      @map("loai_hop_dong")
  tuNgay       DateTime         @map("tu_ngay") @db.Date
  denNgay      DateTime?        @map("den_ngay") @db.Date
  luongCoBan   Decimal          @map("luong_co_ban") @db.Decimal(15, 0)
  luongDongBH  Decimal?         @map("luong_dong_bh") @db.Decimal(15, 0)
  heSoLuong    Decimal?         @map("he_so_luong") @db.Decimal(5, 2)
  // Loại nhân viên theo hợp đồng (chuyển từ NhanVien sang đây)
  loaiNhanVien LoaiNhanVien     @default(CHINH_THUC) @map("loai_nhan_vien")
  trangThai    TrangThaiHopDong @default(HIEU_LUC) @map("trang_thai")
  ghiChu       String?          @map("ghi_chu")
  // File hợp đồng scan (hình hoặc PDF)
  fileHopDong  String?          @map("file_hop_dong")      // URL file chính
  filesHopDong String[]         @map("files_hop_dong")     // Mảng URL nhiều file
  taoBoi       Int?             @map("tao_boi")
  ngayTao      DateTime         @default(now()) @map("ngay_tao")

  // Quan hệ
  nhanVien NhanVien @relation(fields: [nhanVienId], references: [id], onDelete: Cascade)

  @@index([nhanVienId])
  @@index([nhanVienId, tuNgay, denNgay])
  @@index([trangThai])
  @@map("nhan_vien_hop_dong")
}

enum LoaiHopDong {
  THU_VIEC
  MOT_NAM     @map("1_NAM")
  BA_NAM      @map("3_NAM")
  VO_THOI_HAN

  @@map("loai_hop_dong")
}

enum TrangThaiHopDong {
  HIEU_LUC
  HET_HAN
  HUY_BO

  @@map("trang_thai_hop_dong")
}

// ============================================
// NGÂN HÀNG NHÂN VIÊN (để xuất chuyển khoản)
// ============================================
model NhanVienNganHang {
  id          Int       @id @default(autoincrement())
  nhanVienId  Int       @map("nhan_vien_id")
  tenNganHang String    @map("ten_ngan_hang")
  soTaiKhoan  String    @map("so_tai_khoan")
  chuTaiKhoan String    @map("chu_tai_khoan")
  chiNhanh    String?   @map("chi_nhanh")
  laMacDinh   Boolean   @default(true) @map("la_mac_dinh")
  tuNgay      DateTime? @map("tu_ngay") @db.Date
  denNgay     DateTime? @map("den_ngay") @db.Date
  ghiChu      String?   @map("ghi_chu")
  ngayTao     DateTime  @default(now()) @map("ngay_tao")

  // Quan hệ
  nhanVien NhanVien @relation(fields: [nhanVienId], references: [id], onDelete: Cascade)

  @@index([nhanVienId])
  @@index([nhanVienId, laMacDinh])
  @@map("nhan_vien_ngan_hang")
}

// ============================================
// THUẾ / BHXH PLACEHOLDER (để mở rộng)
// ============================================
model NhanVienThueBH {
  id              Int       @id @default(autoincrement())
  nhanVienId      Int       @unique @map("nhan_vien_id")
  mstCaNhan       String?   @map("mst_ca_nhan")
  soCmndCccd      String?   @map("so_cmnd_cccd")
  ngayCap         DateTime? @map("ngay_cap") @db.Date
  noiCap          String?   @map("noi_cap")
  soNguoiPhuThuoc Int       @default(0) @map("so_nguoi_phu_thuoc")
  ghiChu          String?   @map("ghi_chu")
  ngayTao         DateTime  @default(now()) @map("ngay_tao")
  ngayCapNhat     DateTime  @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  nhanVien NhanVien @relation(fields: [nhanVienId], references: [id], onDelete: Cascade)

  @@map("nhan_vien_thue_bh")
}

// ============================================
// CẤU HÌNH ĐƠN GIÁ SẢN LƯỢNG
// ============================================
model CauHinhDonGia {
  id          Int      @id @default(autoincrement())
  maBien      String   @unique @map("ma_bien") // DON_GIA_SP, DON_GIA_KHOI_LUONG, DON_GIA_PHAT_TRE, HE_SO_LOI_SP
  tenBien     String   @map("ten_bien") // Đơn giá sản phẩm, Đơn giá khối lượng...
  moTa        String?  @map("mo_ta")
  giaTri      Decimal  @map("gia_tri") @db.Decimal(15, 2) // Giá trị số
  donVi       String?  @map("don_vi") // VND, %, lần...
  phongBanId  Int?     @map("phong_ban_id") // NULL = toàn công ty
  trangThai   Boolean  @default(true) @map("trang_thai")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  phongBan PhongBan? @relation(fields: [phongBanId], references: [id])

  @@unique([maBien, phongBanId])
  @@map("cau_hinh_don_gia")
}

// ============================================
// NHÓM NHÂN VIÊN (rule điều kiện theo nhóm)
// ============================================
model NhomNhanVien {
  id        Int      @id @default(autoincrement())
  maNhom    String   @unique @map("ma_nhom")
  tenNhom   String   @map("ten_nhom")
  moTa      String?  @map("mo_ta")
  mauSac    String?  @map("mau_sac") // Màu sắc hiển thị (hex)
  trangThai Boolean  @default(true) @map("trang_thai")
  ngayTao   DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  thanhViens NhanVienThuocNhom[]

  @@map("nhom_nhan_vien")
}

// ============================================
// NHÂN VIÊN THUỘC NHÓM (mapping N-N theo thời gian)
// ============================================
model NhanVienThuocNhom {
  id         Int       @id @default(autoincrement())
  nhanVienId Int       @map("nhan_vien_id")
  nhomId     Int       @map("nhom_id")
  tuNgay     DateTime? @map("tu_ngay") @db.Date
  denNgay    DateTime? @map("den_ngay") @db.Date
  ngayTao    DateTime  @default(now()) @map("ngay_tao")

  // Quan hệ
  nhanVien NhanVien     @relation(fields: [nhanVienId], references: [id], onDelete: Cascade)
  nhom     NhomNhanVien @relation(fields: [nhomId], references: [id], onDelete: Cascade)

  @@unique([nhanVienId, nhomId, tuNgay])
  @@index([nhanVienId])
  @@index([nhomId])
  @@map("nhan_vien_thuoc_nhom")
}

// ============================================
// MODULE ỨNG LƯƠNG - BẢNG ỨNG LƯƠNG
// Quản lý ứng lương giữa tháng
// ============================================
model BangUngLuong {
  id               Int                   @id @default(autoincrement())
  maBangUngLuong   String                @unique @map("ma_bang_ung_luong") // UL-YYYYMM-XX
  thangNam         String                @map("thang_nam") // YYYY-MM
  tuNgay           DateTime              @map("tu_ngay") @db.Date
  denNgay          DateTime              @map("den_ngay") @db.Date
  ngayChiTra       DateTime?             @map("ngay_chi_tra") @db.Date
  phongBanId       Int?                  @map("phong_ban_id") // nullable, nếu tạo theo phòng ban
  trangThai        TrangThaiBangUngLuong @default(NHAP) @map("trang_thai")
  cauHinhJson      String?               @map("cau_hinh_json") @db.Text // JSON cấu hình rule
  tongSoTienUng    Decimal               @default(0) @map("tong_so_tien_ung") @db.Decimal(15, 0)
  soNhanVienUng    Int                   @default(0) @map("so_nhan_vien_ung")
  ghiChu           String?               @map("ghi_chu")
  daGhiNhanKhauTru Boolean               @default(false) @map("da_ghi_nhan_khau_tru")
  refPhieuDCId     Int?                  @map("ref_phieu_dc_id") // ID phiếu điều chỉnh đã tạo
  nguoiTao         String?               @map("nguoi_tao")
  ngayTao          DateTime              @default(now()) @map("ngay_tao")
  ngayCapNhat      DateTime              @updatedAt @map("ngay_cap_nhat")
  nguoiChot        String?               @map("nguoi_chot")
  ngayChot         DateTime?             @map("ngay_chot")
  nguoiKhoa        String?               @map("nguoi_khoa")
  ngayKhoa         DateTime?             @map("ngay_khoa")

  // Quan hệ
  chiTiets  ChiTietBangUngLuong[]
  snapshots SnapshotBangUngLuong[]

  @@unique([thangNam, tuNgay, denNgay, phongBanId])
  @@index([thangNam])
  @@index([trangThai])
  @@index([phongBanId])
  @@map("bang_ung_luong")
}

enum TrangThaiBangUngLuong {
  NHAP
  DA_CHOT
  DA_KHOA

  @@map("trang_thai_bang_ung_luong")
}

// ============================================
// CHI TIẾT BẢNG ỨNG LƯƠNG
// Từng dòng nhân viên trong bảng ứng lương
// ============================================
model ChiTietBangUngLuong {
  id                  Int      @id @default(autoincrement())
  bangUngLuongId      Int      @map("bang_ung_luong_id")
  nhanVienId          Int      @map("nhan_vien_id")
  phongBanId          Int      @map("phong_ban_id") // denormalize
  nhomNhanVienId      Int?     @map("nhom_nhan_vien_id") // nullable, denormalize
  // Dữ liệu tính toán
  tienCongLuyKe       Decimal  @default(0) @map("tien_cong_luy_ke") @db.Decimal(15, 0)
  mucToiDaDuocUng     Decimal  @default(0) @map("muc_toi_da_duoc_ung") @db.Decimal(15, 0)
  soNgayCong          Decimal  @default(0) @map("so_ngay_cong") @db.Decimal(5, 2)
  soNgayNghi          Decimal  @default(0) @map("so_ngay_nghi") @db.Decimal(5, 2)
  soNgayNghiKhongPhep Decimal  @default(0) @map("so_ngay_nghi_khong_phep") @db.Decimal(5, 2)
  laTamTinh           Boolean  @default(false) @map("la_tam_tinh") // True = tạm tính theo lịch (chưa có chấm công thực tế)
  // Kết quả đánh giá
  duocPhepUng         Boolean  @default(true) @map("duoc_phep_ung")
  lyDoKhongDat        String?  @map("ly_do_khong_dat") // NGHI_QUA_NHIEU | NGHI_KHONG_PHEP | KHONG_HOAT_DONG | KHAC
  // Số tiền ứng
  soTienUngDeXuat     Decimal  @default(0) @map("so_tien_ung_de_xuat") @db.Decimal(15, 0)
  soTienUngDuyet      Decimal  @default(0) @map("so_tien_ung_duyet") @db.Decimal(15, 0)
  ghiChu              String?  @map("ghi_chu")
  lockedBySnapshot    Boolean  @default(false) @map("locked_by_snapshot")
  ngayTao             DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat         DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  bangUngLuong BangUngLuong @relation(fields: [bangUngLuongId], references: [id], onDelete: Cascade)

  @@unique([bangUngLuongId, nhanVienId])
  @@index([bangUngLuongId])
  @@index([nhanVienId])
  @@index([phongBanId])
  @@map("chi_tiet_bang_ung_luong")
}

// ============================================
// SNAPSHOT BẢNG ỨNG LƯƠNG (header)
// Lưu ảnh chụp khi chốt/khóa
// ============================================
model SnapshotBangUngLuong {
  id             Int      @id @default(autoincrement())
  bangUngLuongId Int      @map("bang_ung_luong_id")
  maBangUngLuong String   @map("ma_bang_ung_luong")
  thangNam       String   @map("thang_nam")
  tuNgay         DateTime @map("tu_ngay") @db.Date
  denNgay        DateTime @map("den_ngay") @db.Date
  cauHinhJson    String?  @map("cau_hinh_json") @db.Text
  tongSoTienUng  Decimal  @map("tong_so_tien_ung") @db.Decimal(15, 0)
  soNhanVienUng  Int      @map("so_nhan_vien_ung")
  ngayChot       DateTime @map("ngay_chot")
  nguoiChot      String   @map("nguoi_chot")
  ngayTao        DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  bangUngLuong BangUngLuong                  @relation(fields: [bangUngLuongId], references: [id], onDelete: Cascade)
  chiTiets     SnapshotChiTietBangUngLuong[]

  @@index([bangUngLuongId])
  @@map("snapshot_bang_ung_luong")
}

// ============================================
// SNAPSHOT CHI TIẾT BẢNG ỨNG LƯƠNG
// Lưu dữ liệu đầu vào để giải trình
// ============================================
model SnapshotChiTietBangUngLuong {
  id                  Int      @id @default(autoincrement())
  snapshotId          Int      @map("snapshot_id")
  nhanVienId          Int      @map("nhan_vien_id")
  maNhanVien          String   @map("ma_nhan_vien")
  hoTen               String   @map("ho_ten")
  phongBan            String   @map("phong_ban")
  nhomNhanVien        String?  @map("nhom_nhan_vien")
  // Dữ liệu tính toán tại thời điểm chốt
  tienCongLuyKe       Decimal  @map("tien_cong_luy_ke") @db.Decimal(15, 0)
  mucToiDaDuocUng     Decimal  @map("muc_toi_da_duoc_ung") @db.Decimal(15, 0)
  soNgayCong          Decimal  @map("so_ngay_cong") @db.Decimal(5, 2)
  soNgayNghi          Decimal  @map("so_ngay_nghi") @db.Decimal(5, 2)
  soNgayNghiKhongPhep Decimal  @map("so_ngay_nghi_khong_phep") @db.Decimal(5, 2)
  duocPhepUng         Boolean  @map("duoc_phep_ung")
  lyDoKhongDat        String?  @map("ly_do_khong_dat")
  soTienUngDeXuat     Decimal  @map("so_tien_ung_de_xuat") @db.Decimal(15, 0)
  soTienUngDuyet      Decimal  @map("so_tien_ung_duyet") @db.Decimal(15, 0)
  ghiChu              String?  @map("ghi_chu")
  // Dữ liệu input để trace (JSON)
  inputDataJson       String?  @map("input_data_json") @db.Text // chi tiết sản lượng, chấm công, lương...
  ngayTao             DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  snapshot SnapshotBangUngLuong @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
  @@index([nhanVienId])
  @@map("snapshot_chi_tiet_bang_ung_luong")
}

// ============================================
// MODULE NGHỈ PHÉP (LITE)
// ============================================

// Danh mục loại nghỉ phép
model DanhMucLoaiNghi {
  id              Int     @id @default(autoincrement())
  maLoaiNghi      String  @unique @map("ma_loai_nghi") // VD: PHEP_NAM, OM, KHONG_LUONG, KHONG_PHEP
  tenLoaiNghi     String  @map("ten_loai_nghi")
  nhomLoai        String  @map("nhom_loai") // CO_PHEP | KHONG_PHEP
  coTinhLuong     Boolean @default(true) @map("co_tinh_luong") // Loại này có được tính lương không
  coTinhChuyenCan Boolean @default(false) @map("co_tinh_chuyen_can") // Nghỉ loại này có làm mất chuyên cần không
  thuTuHienThi    Int     @default(0) @map("thu_tu_hien_thi")
  isActive        Boolean @default(true) @map("is_active")

  // Audit
  taoBoi      Int?     @map("tao_boi")
  capNhatBoi  Int?     @map("cap_nhat_boi")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  donNghiPheps     DonNghiPhep[]
  chiTietNghiPheps ChiTietNghiPhepNgay[]

  @@index([nhomLoai])
  @@index([isActive])
  @@map("danh_muc_loai_nghi")
}

// Đơn nghỉ phép
model DonNghiPhep {
  id            Int                  @id @default(autoincrement())
  maDon         String               @unique @map("ma_don") // Format: NP-YYYYMM-XXXXX
  nhanVienId    Int                  @map("nhan_vien_id")
  phongBanId    Int                  @map("phong_ban_id") // Denormalize
  loaiNghiId    Int                  @map("loai_nghi_id")
  tuNgay        DateTime             @map("tu_ngay") @db.Date
  denNgay       DateTime             @map("den_ngay") @db.Date
  soNgayNghi    Decimal              @map("so_ngay_nghi") @db.Decimal(5, 2) // Computed
  lyDo          String?              @map("ly_do")
  tepDinhKemUrl String?              @map("tep_dinh_kem_url")
  trangThai     TrangThaiDonNghiPhep @default(NHAP) @map("trang_thai")

  // Duyệt
  nguoiDuyetId Int?      @map("nguoi_duyet_id")
  ngayDuyet    DateTime? @map("ngay_duyet")
  lyDoTuChoi   String?   @map("ly_do_tu_choi")

  // Audit
  taoBoi      Int?     @map("tao_boi")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  nhanVien     NhanVien              @relation(fields: [nhanVienId], references: [id])
  phongBan     PhongBan              @relation(fields: [phongBanId], references: [id])
  loaiNghi     DanhMucLoaiNghi       @relation(fields: [loaiNghiId], references: [id])
  nguoiDuyet   NguoiDung?            @relation("NguoiDuyetDon", fields: [nguoiDuyetId], references: [id])
  chiTietNgays ChiTietNghiPhepNgay[]

  @@unique([nhanVienId, tuNgay, denNgay, loaiNghiId])
  @@index([nhanVienId])
  @@index([phongBanId])
  @@index([loaiNghiId])
  @@index([trangThai])
  @@index([tuNgay, denNgay])
  @@map("don_nghi_phep")
}

// Chi tiết ngày nghỉ (explode từng ngày)
model ChiTietNghiPhepNgay {
  id              Int      @id @default(autoincrement())
  donNghiPhepId   Int      @map("don_nghi_phep_id")
  nhanVienId      Int      @map("nhan_vien_id")
  ngay            DateTime @map("ngay") @db.Date
  soGioNghi       Decimal  @default(8) @map("so_gio_nghi") @db.Decimal(4, 2) // Mặc định 8 giờ = 1 ngày
  loaiNghiId      Int      @map("loai_nghi_id")
  coTinhLuong     Boolean  @map("co_tinh_luong")
  coTinhChuyenCan Boolean  @map("co_tinh_chuyen_can")

  ngayTao DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  donNghiPhep DonNghiPhep     @relation(fields: [donNghiPhepId], references: [id], onDelete: Cascade)
  nhanVien    NhanVien        @relation(fields: [nhanVienId], references: [id])
  loaiNghi    DanhMucLoaiNghi @relation(fields: [loaiNghiId], references: [id])

  @@unique([nhanVienId, ngay, loaiNghiId])
  @@index([nhanVienId, ngay])
  @@index([donNghiPhepId])
  @@map("chi_tiet_nghi_phep_ngay")
}

// Enum trạng thái đơn nghỉ
enum TrangThaiDonNghiPhep {
  NHAP // Nhân viên đang nhập, có thể sửa/xóa
  GUI_DUYET // Đã gửi duyệt, khóa chỉnh sửa
  DA_DUYET // Đã duyệt, mapping vào chấm công/ngày công
  TU_CHOI // Bị từ chối, có thể sửa và gửi lại
  HUY // Đã hủy
}

// ============================================
// MODULE XẾP CA (SCHEDULING) — PHASE 2
// Quản lý ca làm việc và phân ca cho nhân viên
// ============================================

// Danh mục ca làm việc
model CaLamViec {
  id             Int      @id @default(autoincrement())
  maCa           String   @unique @map("ma_ca") // VD: CA_HANH_CHINH, CA_DEM, CA_1
  tenCa          String   @map("ten_ca")
  gioVao         String   @map("gio_vao") // Format: HH:mm (VD: "08:00")
  gioRa          String   @map("gio_ra") // Format: HH:mm (VD: "17:00")
  nghiGiuaCaPhut Int      @default(60) @map("nghi_giua_ca_phut") // Phút nghỉ giữa ca
  graceInPhut    Int      @default(5) @map("grace_in_phut") // Phút được phép check-in trước
  graceLatePhut  Int      @default(5) @map("grace_late_phut") // Phút được phép đi trễ
  isCaDem        Boolean  @default(false) @map("is_ca_dem") // Ca qua ngày (22:00 -> 06:00)
  phongBanId     Int?     @map("phong_ban_id") // null = áp dụng toàn công ty
  moTa           String?  @map("mo_ta")
  mauHienThi     String?  @map("mau_hien_thi") // Mã màu hiển thị trên calendar (#FF5733)
  trangThai      Boolean  @default(true) @map("trang_thai") // Active/Inactive

  // Audit
  taoBoi      Int?     @map("tao_boi")
  capNhatBoi  Int?     @map("cap_nhat_boi")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  lichPhanCaChiTiets LichPhanCaChiTiet[]
  chiTietChamCongs   ChiTietChamCong[]

  @@index([phongBanId])
  @@index([trangThai])
  @@map("ca_lam_viec")
}

// Lịch phân ca theo tháng
model LichPhanCa {
  id         Int              @id @default(autoincrement())
  thangNam   String           @map("thang_nam") // Format: YYYY-MM (VD: "2026-01")
  phongBanId Int?             @map("phong_ban_id") // Phân ca theo phòng ban
  nhomId     Int?             @map("nhom_id") // Hoặc theo nhóm nhân viên
  tenLich    String?          @map("ten_lich") // Tên lịch (VD: "Lịch tháng 1/2026 - Kho")
  ghiChu     String?          @map("ghi_chu")
  trangThai  TrangThaiLichCa  @default(NHAP) @map("trang_thai")

  // Publish info
  ngayCongBo   DateTime? @map("ngay_cong_bo")
  nguoiCongBo  Int?      @map("nguoi_cong_bo")

  // Audit
  taoBoi      Int?     @map("tao_boi")
  capNhatBoi  Int?     @map("cap_nhat_boi")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  chiTiets LichPhanCaChiTiet[]

  @@unique([thangNam, phongBanId, nhomId])
  @@index([thangNam])
  @@index([phongBanId])
  @@index([nhomId])
  @@index([trangThai])
  @@map("lich_phan_ca")
}

// Chi tiết phân ca từng ngày cho từng nhân viên
model LichPhanCaChiTiet {
  id           Int      @id @default(autoincrement())
  lichPhanCaId Int      @map("lich_phan_ca_id")
  nhanVienId   Int      @map("nhan_vien_id")
  ngay         DateTime @map("ngay") @db.Date // Ngày cụ thể
  caLamViecId  Int      @map("ca_lam_viec_id")
  ghiChu       String?  @map("ghi_chu")

  // Audit
  taoBoi  Int?     @map("tao_boi")
  ngayTao DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  lichPhanCa LichPhanCa @relation(fields: [lichPhanCaId], references: [id], onDelete: Cascade)
  caLamViec  CaLamViec  @relation(fields: [caLamViecId], references: [id])

  @@unique([nhanVienId, ngay]) // 1 nhân viên chỉ có 1 ca/ngày
  @@index([lichPhanCaId])
  @@index([nhanVienId])
  @@index([ngay])
  @@index([caLamViecId])
  @@map("lich_phan_ca_chi_tiet")
}

// Enum trạng thái lịch phân ca
enum TrangThaiLichCa {
  NHAP // Đang nhập, có thể sửa
  DA_CONG_BO // Đã publish, đã mapping sang chấm công
  HUY // Đã hủy

  @@map("trang_thai_lich_ca")
}

// ============================================
// MODULE REQUEST (YÊU CẦU) — SPRINT 4
// Request: OT, Trễ giờ, Về sớm, Công tác, Làm từ xa
// Workflow duyệt 1-2 cấp
// ============================================

// Danh mục loại yêu cầu
model DanhMucLoaiYeuCau {
  id              Int     @id @default(autoincrement())
  maLoai          String  @unique @map("ma_loai") // OT, TRE_GIO, VE_SOM, CONG_TAC, LAM_TU_XA
  tenLoai         String  @map("ten_loai")
  moTa            String? @map("mo_ta")
  nhomLoai        String  @map("nhom_loai") // THOI_GIAN | DI_CHUYEN | KHAC
  yeuCauGioBatDau Boolean @default(false) @map("yeu_cau_gio_bat_dau") // Yêu cầu nhập giờ bắt đầu
  yeuCauGioKetThuc Boolean @default(false) @map("yeu_cau_gio_ket_thuc") // Yêu cầu nhập giờ kết thúc
  yeuCauDiaDiem   Boolean @default(false) @map("yeu_cau_dia_diem") // Yêu cầu nhập địa điểm
  coTinhOT        Boolean @default(false) @map("co_tinh_ot") // Có tính OT không
  thuTuHienThi    Int     @default(0) @map("thu_tu_hien_thi")
  isActive        Boolean @default(true) @map("is_active")
  mauHienThi      String? @map("mau_hien_thi") // Màu hiển thị (#FF5733)
  icon            String? @map("icon") // Icon name (clock, car, home...)

  // Audit
  taoBoi      Int?     @map("tao_boi")
  capNhatBoi  Int?     @map("cap_nhat_boi")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  donYeuCaus         DonYeuCau[]
  workflowConfigs    RequestWorkflowConfig[]

  @@index([nhomLoai])
  @@index([isActive])
  @@map("danh_muc_loai_yeu_cau")
}

// Đơn yêu cầu
model DonYeuCau {
  id            Int                @id @default(autoincrement())
  maDon         String             @unique @map("ma_don") // Format: REQ-YYYYMM-XXXXX
  nhanVienId    Int                @map("nhan_vien_id")
  phongBanId    Int                @map("phong_ban_id") // Denormalize để lọc nhanh
  loaiYeuCauId  Int                @map("loai_yeu_cau_id")
  
  // Thời gian yêu cầu
  ngayYeuCau    DateTime           @map("ngay_yeu_cau") @db.Date // Ngày áp dụng
  gioBatDau     String?            @map("gio_bat_dau") // Format: HH:mm
  gioKetThuc    String?            @map("gio_ket_thuc") // Format: HH:mm
  soGio         Decimal?           @map("so_gio") @db.Decimal(5, 2) // Số giờ tính toán
  
  // Thông tin bổ sung
  diaDiem       String?            @map("dia_diem")
  lyDo          String             @map("ly_do")
  tepDinhKemUrl String?            @map("tep_dinh_kem_url")
  
  // Trạng thái workflow
  trangThai     TrangThaiDonYeuCau @default(NHAP) @map("trang_thai")
  
  // Duyệt cấp 1 (Manager)
  nguoiDuyet1Id  Int?       @map("nguoi_duyet_1_id")
  ngayDuyet1     DateTime?  @map("ngay_duyet_1")
  ghiChuDuyet1   String?    @map("ghi_chu_duyet_1")
  
  // Duyệt cấp 2 (HR)
  nguoiDuyet2Id  Int?       @map("nguoi_duyet_2_id")
  ngayDuyet2     DateTime?  @map("ngay_duyet_2")
  ghiChuDuyet2   String?    @map("ghi_chu_duyet_2")
  
  // Từ chối
  lyDoTuChoi    String?    @map("ly_do_tu_choi")
  
  // Override (HR có thể override quyết định)
  isOverride    Boolean    @default(false) @map("is_override")
  lyDoOverride  String?    @map("ly_do_override")
  nguoiOverrideId Int?     @map("nguoi_override_id")

  // Audit
  taoBoi      Int?     @map("tao_boi")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  nhanVien       NhanVien             @relation(fields: [nhanVienId], references: [id])
  phongBan       PhongBan             @relation(fields: [phongBanId], references: [id])
  loaiYeuCau     DanhMucLoaiYeuCau    @relation(fields: [loaiYeuCauId], references: [id])
  nguoiDuyet1    NguoiDung?           @relation("NguoiDuyet1", fields: [nguoiDuyet1Id], references: [id])
  nguoiDuyet2    NguoiDung?           @relation("NguoiDuyet2", fields: [nguoiDuyet2Id], references: [id])
  nguoiOverride  NguoiDung?           @relation("NguoiOverride", fields: [nguoiOverrideId], references: [id])
  mappingChamCong RequestMappingChamCong[]

  @@unique([nhanVienId, ngayYeuCau, loaiYeuCauId, gioBatDau]) // Tránh trùng đơn
  @@index([nhanVienId])
  @@index([phongBanId])
  @@index([loaiYeuCauId])
  @@index([trangThai])
  @@index([ngayYeuCau])
  @@index([nguoiDuyet1Id])
  @@index([nguoiDuyet2Id])
  @@map("don_yeu_cau")
}

// Cấu hình workflow duyệt theo phòng ban/loại yêu cầu
model RequestWorkflowConfig {
  id             Int     @id @default(autoincrement())
  loaiYeuCauId   Int     @map("loai_yeu_cau_id")
  phongBanId     Int?    @map("phong_ban_id") // null = áp dụng toàn công ty
  
  // Cấu hình workflow
  soCap          Int     @default(1) @map("so_cap") // 1 hoặc 2 cấp
  nguoiDuyet1    String  @map("nguoi_duyet_1") // QUAN_LY_TRUC_TIEP | TRUONG_PHONG | NGUOI_DUNG_CU_THE
  nguoiDuyetCuThe1Id Int? @map("nguoi_duyet_cu_the_1_id") // Nếu chọn cụ thể
  nguoiDuyet2    String? @map("nguoi_duyet_2") // HR | NGUOI_DUNG_CU_THE
  nguoiDuyetCuThe2Id Int? @map("nguoi_duyet_cu_the_2_id")
  
  // Các quy tắc
  tuDongDuyetNeuQuaHan  Boolean @default(false) @map("tu_dong_duyet_neu_qua_han") // Quá hạn tự duyệt
  soNgayQuaHan          Int?    @map("so_ngay_qua_han")
  yeuCauLyDoTuChoi      Boolean @default(true) @map("yeu_cau_ly_do_tu_choi")
  yeuCauLyDoOverride    Boolean @default(true) @map("yeu_cau_ly_do_override")
  
  isActive       Boolean @default(true) @map("is_active")

  // Audit
  taoBoi      Int?     @map("tao_boi")
  capNhatBoi  Int?     @map("cap_nhat_boi")
  ngayTao     DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  loaiYeuCau DanhMucLoaiYeuCau @relation(fields: [loaiYeuCauId], references: [id])

  @@unique([loaiYeuCauId, phongBanId])
  @@index([loaiYeuCauId])
  @@index([phongBanId])
  @@map("request_workflow_config")
}

// Mapping yêu cầu đã duyệt vào chấm công
model RequestMappingChamCong {
  id            Int      @id @default(autoincrement())
  donYeuCauId   Int      @map("don_yeu_cau_id")
  nhanVienId    Int      @map("nhan_vien_id")
  ngay          DateTime @map("ngay") @db.Date
  
  // Dữ liệu mapping
  loaiMapping   String   @map("loai_mapping") // OT | HOP_THUC_TRE | HOP_THUC_SOM | CONG_TAC | LAM_TU_XA
  soGioApDung   Decimal? @map("so_gio_ap_dung") @db.Decimal(5, 2)
  ghiChu        String?  @map("ghi_chu")
  
  // Trạng thái
  daApDung      Boolean  @default(false) @map("da_ap_dung") // Đã apply vào ChiTietChamCong
  ngayApDung    DateTime? @map("ngay_ap_dung")
  
  // Check snapshot
  kyLuongId     Int?     @map("ky_luong_id") // Nếu đã snapshot thì không được sửa
  isLocked      Boolean  @default(false) @map("is_locked")

  ngayTao       DateTime @default(now()) @map("ngay_tao")

  // Quan hệ
  donYeuCau     DonYeuCau @relation(fields: [donYeuCauId], references: [id], onDelete: Cascade)

  @@unique([donYeuCauId, ngay])
  @@index([nhanVienId, ngay])
  @@index([donYeuCauId])
  @@index([daApDung])
  @@map("request_mapping_cham_cong")
}

// Enum trạng thái đơn yêu cầu (workflow 2 cấp)
enum TrangThaiDonYeuCau {
  NHAP           // Nhân viên đang nhập
  CHO_DUYET_1    // Chờ manager duyệt
  CHO_DUYET_2    // Chờ HR duyệt (nếu 2 cấp)
  DA_DUYET       // Đã duyệt hoàn tất
  TU_CHOI        // Bị từ chối
  HUY            // Đã hủy
  
  @@map("trang_thai_don_yeu_cau")
}

// =====================================
// SPRINT 6: THÔNG BÁO (NOTIFICATION)
// =====================================

// Loại thông báo
enum LoaiThongBao {
  YEU_CAU_MOI          // Có yêu cầu mới cần duyệt
  YEU_CAU_DA_DUYET     // Yêu cầu đã được duyệt
  YEU_CAU_TU_CHOI      // Yêu cầu bị từ chối
  NGHI_PHEP_MOI        // Có đơn nghỉ mới cần duyệt
  NGHI_PHEP_DA_DUYET   // Đơn nghỉ đã được duyệt
  NGHI_PHEP_TU_CHOI    // Đơn nghỉ bị từ chối
  LICH_PHAN_CA         // Lịch phân ca mới được công bố
  PHIEU_LUONG          // Phiếu lương đã sẵn sàng
  NHAC_NHO             // Nhắc nhở duyệt đơn
  HE_THONG             // Thông báo hệ thống
  
  @@map("loai_thong_bao")
}

// Thông báo
model ThongBao {
  id            Int          @id @default(autoincrement())
  nguoiNhanId   Int          @map("nguoi_nhan_id") // User nhận thông báo
  loaiThongBao  LoaiThongBao @map("loai_thong_bao")
  tieuDe        String       @map("tieu_de") @db.VarChar(200)
  noiDung       String       @map("noi_dung") @db.Text
  link          String?      @map("link") @db.VarChar(500) // Link để navigate đến
  
  // Trạng thái
  daDoc         Boolean      @default(false) @map("da_doc")
  ngayDoc       DateTime?    @map("ngay_doc")
  
  // Metadata
  duLieuThem    Json?        @map("du_lieu_them") // Thông tin bổ sung (requestId, etc.)
  ngayTao       DateTime     @default(now()) @map("ngay_tao")
  
  // Quan hệ
  nguoiNhan     NguoiDung    @relation(fields: [nguoiNhanId], references: [id], onDelete: Cascade)

  @@index([nguoiNhanId, daDoc])
  @@index([nguoiNhanId, ngayTao])
  @@index([loaiThongBao])
  @@map("thong_bao")
}

// =====================================
// SPRINT 7: ANTI-FRAUD GPS + GEOFENCE
// =====================================

// Cấu hình Geofence theo địa điểm làm việc
model CauHinhGeofence {
  id            Int      @id @default(autoincrement())
  tenDiaDiem    String   @map("ten_dia_diem") @db.VarChar(200)        // Tên địa điểm (VD: "Văn phòng HQ", "Nhà máy ABC")
  diaChi        String?  @map("dia_chi") @db.VarChar(500)             // Địa chỉ đầy đủ
  viDo          Decimal  @map("vi_do") @db.Decimal(10, 8)             // Latitude
  kinhDo        Decimal  @map("kinh_do") @db.Decimal(11, 8)           // Longitude
  banKinhMet    Int      @map("ban_kinh_met") @default(100)           // Bán kính cho phép (mét)
  
  // Phạm vi áp dụng
  phongBanId    Int?     @map("phong_ban_id")                          // null = toàn công ty
  apDungTatCa   Boolean  @default(false) @map("ap_dung_tat_ca")        // true = áp dụng toàn công ty
  
  // Cấu hình
  batBuocGPS    Boolean  @default(true) @map("bat_buoc_gps")           // Bắt buộc bật GPS khi check-in
  chanNgoaiVung Boolean  @default(false) @map("chan_ngoai_vung")       // Chặn check-in ngoài vùng (false = chỉ cảnh báo)
  trangThai     Boolean  @default(true) @map("trang_thai")             // Hoạt động/Ngừng
  
  // Audit
  taoBoi        Int?     @map("tao_boi")
  capNhatBoi    Int?     @map("cap_nhat_boi")
  ngayTao       DateTime @default(now()) @map("ngay_tao")
  ngayCapNhat   DateTime @updatedAt @map("ngay_cap_nhat")

  // Quan hệ
  bangGhiGPS    BangGhiChamCongGPS[]
  
  @@index([phongBanId])
  @@index([trangThai])
  @@map("cau_hinh_geofence")
}

// Bảng ghi chấm công GPS - lưu trữ tọa độ mỗi lần check-in/out
model BangGhiChamCongGPS {
  id              Int       @id @default(autoincrement())
  nhanVienId      Int       @map("nhan_vien_id")
  thoiGian        DateTime  @map("thoi_gian")                         // Thời điểm check-in/out
  loaiChamCong    String    @map("loai_cham_cong")                    // CHECK_IN | CHECK_OUT
  
  // Thông tin GPS
  viDo            Decimal?  @map("vi_do") @db.Decimal(10, 8)          // Latitude
  kinhDo          Decimal?  @map("kinh_do") @db.Decimal(11, 8)        // Longitude
  doChinhXacMet   Int?      @map("do_chinh_xac_met")                  // Độ chính xác GPS (mét)
  
  // Kết quả kiểm tra geofence
  geofenceId      Int?      @map("geofence_id")                       // Geofence được match
  khoangCachMet   Int?      @map("khoang_cach_met")                   // Khoảng cách từ điểm check đến tâm geofence
  trongVung       Boolean?  @map("trong_vung")                        // true = trong vùng cho phép
  
  // Trạng thái
  trangThai       String    @default("HOP_LE") @map("trang_thai")     // HOP_LE | NGOAI_VUNG | KHONG_CO_GPS | CANH_BAO
  ghiChu          String?   @map("ghi_chu") @db.Text                  // Ghi chú nếu có vấn đề
  
  // Thông tin thiết bị
  deviceId        String?   @map("device_id") @db.VarChar(100)        // ID thiết bị
  userAgent       String?   @map("user_agent") @db.VarChar(500)       // Browser/App info
  ipAddress       String?   @map("ip_address") @db.VarChar(50)        // IP address
  
  ngayTao         DateTime  @default(now()) @map("ngay_tao")

  // Quan hệ
  geofence        CauHinhGeofence? @relation(fields: [geofenceId], references: [id])
  
  @@index([nhanVienId, thoiGian])
  @@index([thoiGian])
  @@index([trangThai])
  @@index([geofenceId])
  @@map("bang_ghi_cham_cong_gps")
}

// ==================== SPRINT 8: DEVICE BINDING ====================

// Thiết bị nhân viên - Binding 1 device per employee
model ThietBiNhanVien {
  id              Int       @id @default(autoincrement())
  nhanVienId      Int       @unique @map("nhan_vien_id")              // 1 nhân viên = 1 thiết bị
  deviceId        String    @map("device_id") @db.VarChar(255)        // Device fingerprint/ID
  tenThietBi      String?   @map("ten_thiet_bi") @db.VarChar(255)     // Tên thiết bị (e.g. "iPhone 15 Pro")
  userAgent       String?   @map("user_agent") @db.VarChar(500)       // Browser/App info
  platform        String?   @map("platform") @db.VarChar(50)          // iOS/Android/Web
  ipAddress       String?   @map("ip_address") @db.VarChar(50)        // IP đăng ký
  
  // Trạng thái
  trangThai       String    @default("ACTIVE") @map("trang_thai")     // ACTIVE | BLOCKED | PENDING_RESET
  ngayDangKy      DateTime  @default(now()) @map("ngay_dang_ky")      // Ngày binding
  lanDangNhapCuoi DateTime? @map("lan_dang_nhap_cuoi")                // Lần login cuối từ device này
  
  // Audit
  nguoiResetId    Int?      @map("nguoi_reset_id")                    // HR/Admin reset device
  lyDoReset       String?   @map("ly_do_reset") @db.Text              // Lý do reset
  ngayReset       DateTime? @map("ngay_reset")                        // Ngày reset gần nhất
  
  ngayTao         DateTime  @default(now()) @map("ngay_tao")
  ngayCapNhat     DateTime  @updatedAt @map("ngay_cap_nhat")

  @@index([deviceId])
  @@index([trangThai])
  @@map("thiet_bi_nhan_vien")
}

// Log lịch sử thiết bị - audit trail
model LichSuThietBi {
  id              Int       @id @default(autoincrement())
  nhanVienId      Int       @map("nhan_vien_id")
  hanhDong        String    @map("hanh_dong")                         // BIND | UNBIND | RESET | BLOCK | LOGIN_BLOCKED
  deviceIdCu      String?   @map("device_id_cu") @db.VarChar(255)     // Device cũ (nếu reset)
  deviceIdMoi     String?   @map("device_id_moi") @db.VarChar(255)    // Device mới
  nguoiThucHienId Int?      @map("nguoi_thuc_hien_id")                // Người thực hiện (HR/Admin/System)
  lyDo            String?   @map("ly_do") @db.Text                    // Lý do thao tác
  ipAddress       String?   @map("ip_address") @db.VarChar(50)
  userAgent       String?   @map("user_agent") @db.VarChar(500)
  ngayTao         DateTime  @default(now()) @map("ngay_tao")

  @@index([nhanVienId])
  @@index([hanhDong])
  @@index([ngayTao])
  @@map("lich_su_thiet_bi")
}

// ==================== SPRINT 9: TIMESHEET MANAGEMENT ====================

// Yêu cầu sửa công - với workflow phê duyệt
model YeuCauSuaCong {
  id              Int       @id @default(autoincrement())
  nhanVienId      Int       @map("nhan_vien_id")
  ngayChamCong    DateTime  @map("ngay_cham_cong")                    // Ngày cần sửa
  
  // Giá trị cũ (trước khi sửa)
  gioVaoCu        DateTime? @map("gio_vao_cu")
  gioRaCu         DateTime? @map("gio_ra_cu")
  trangThaiCu     String?   @map("trang_thai_cu")                     // DI_LAM | NGHI_PHEP | ...
  
  // Giá trị mới (đề xuất)
  gioVaoMoi       DateTime? @map("gio_vao_moi")
  gioRaMoi        DateTime? @map("gio_ra_moi")
  trangThaiMoi    String?   @map("trang_thai_moi")
  
  // Lý do và ghi chú
  lyDo            String    @map("ly_do") @db.Text                    // Lý do sửa công (bắt buộc)
  bangChung       String?   @map("bang_chung") @db.Text               // Link ảnh/file minh chứng
  
  // Workflow phê duyệt
  trangThaiDuyet  String    @default("CHO_DUYET") @map("trang_thai_duyet") // CHO_DUYET | DA_DUYET | TU_CHOI
  nguoiDuyetId    Int?      @map("nguoi_duyet_id")
  ngayDuyet       DateTime? @map("ngay_duyet")
  lyDoTuChoi      String?   @map("ly_do_tu_choi") @db.Text
  
  // Audit
  nguoiTaoId      Int       @map("nguoi_tao_id")                      // Người tạo yêu cầu (NV hoặc HR)
  ngayTao         DateTime  @default(now()) @map("ngay_tao")
  ngayCapNhat     DateTime  @updatedAt @map("ngay_cap_nhat")
  
  @@index([nhanVienId])
  @@index([ngayChamCong])
  @@index([trangThaiDuyet])
  @@index([nguoiTaoId])
  @@map("yeu_cau_sua_cong")
}

// Lịch sử sửa công - Audit trail cho mọi thay đổi bảng công
model LichSuSuaCong {
  id              Int       @id @default(autoincrement())
  nhanVienId      Int       @map("nhan_vien_id")
  ngayChamCong    DateTime  @map("ngay_cham_cong")
  
  // Thay đổi
  truongThayDoi   String    @map("truong_thay_doi")                   // gioVao | gioRa | trangThai | ...
  giaTriCu        String?   @map("gia_tri_cu")
  giaTriMoi       String?   @map("gia_tri_moi")
  
  // Nguồn thay đổi
  nguonThayDoi    String    @map("nguon_thay_doi")                    // MANUAL | YEU_CAU | IMPORT | DON_NGHI | DON_YEU_CAU
  yeuCauSuaCongId Int?      @map("yeu_cau_sua_cong_id")               // Link đến yêu cầu nếu có
  
  // Audit
  nguoiThucHienId Int       @map("nguoi_thuc_hien_id")
  ghiChu          String?   @map("ghi_chu") @db.Text
  ngayTao         DateTime  @default(now()) @map("ngay_tao")
  
  @@index([nhanVienId, ngayChamCong])
  @@index([nguonThayDoi])
  @@index([ngayTao])
  @@map("lich_su_sua_cong")
}

// ================================================
// CHATBOT - Lịch sử hội thoại & Analytics
// ================================================

model ChatHistory {
  id        Int      @id @default(autoincrement())
  sessionId String   @map("session_id") @db.Uuid
  userId    Int?     @map("user_id")
  role      String   // user | assistant
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@index([userId])
  @@index([createdAt])
  @@map("chat_history")
}

model ChatAnalytics {
  id           Int      @id @default(autoincrement())
  query        String   @db.Text
  sourcesCount Int      @default(0) @map("sources_count")
  userId       Int?     @map("user_id")
  sessionId    String?  @map("session_id") @db.Uuid
  feedback     Int?     // -1, 0, 1 (dislike, neutral, like)
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_analytics")
}
